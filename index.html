<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Legal Letter Generation System</title>
    <!-- Include SheetJS library for Excel handling -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script>
        // ===================================================================
        // GLOBAL VARIABLES - Define at the very top
        // ===================================================================
        var clients = [];
        var currentClient = null;
        var currentCDRData = null;
        
        // ===================================================================
        // UTILITY FUNCTIONS - Define these first as they're used everywhere
        // ===================================================================
        
        // Format date for display
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const options = { day: 'numeric', month: 'long', year: 'numeric' };
            return date.toLocaleDateString('en-AU', options);
        }
        
        // Get today's date in YYYY-MM-DD format
        function getTodayDate() {
            return new Date().toISOString().split('T')[0];
        }
        
        // Get template file name based on letter type
        function getTemplateFileName(letterType) {
            const templateMap = {
                'CCL': 'CCL_Template.docx',
                'Mention': 'Mention_Template.docx',
                'Final': 'Final_Template.docx',
                'FeeReestimate': 'FeeReestimate_Template.docx'
            };
            return templateMap[letterType] || 'Template.docx';
        }
        
        // ===================================================================
        // DATA PERSISTENCE FUNCTIONS
        // ===================================================================
        
        // Save data to localStorage
        function saveData() {
            try {
                // Note: localStorage won't work in Claude artifacts, but keeping for external use
                if (typeof(Storage) !== "undefined") {
                    localStorage.setItem('legalClients', JSON.stringify(clients));
                }
            } catch(e) {
                console.log('Storage not available in this environment');
            }
        }
        
        // Load saved data from localStorage
        function loadSavedData() {
            try {
                if (typeof(Storage) !== "undefined") {
                    const savedClients = localStorage.getItem('legalClients');
                    if (savedClients) {
                        clients = JSON.parse(savedClients);
                        updateDatabaseStatus(true);
                    }
                }
            } catch(e) {
                console.log('Storage not available in this environment');
            }
        }
        
        // ===================================================================
        // UI UPDATE FUNCTIONS
        // ===================================================================
        
        // Update database status indicator
        function updateDatabaseStatus(connected) {
            const status = document.getElementById('databaseStatus');
            if (status) {
                if (connected) {
                    status.textContent = `Database: Connected (${clients.length} clients)`;
                    status.className = 'database-status status-connected';
                } else {
                    status.textContent = 'Database: Not Connected';
                    status.className = 'database-status status-disconnected';
                }
            }
        }
        
        // Master update function that calls all UI updates
        function updateUI() {
            loadClientTable();
            loadClientSelect();
            loadCDRClientSelect();
            updateAnalytics();
        }
        
        // Load client table
        function loadClientTable() {
            const tbody = document.getElementById('clientTableBody');
            if (!tbody) return;
            
            if (clients.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" style="text-align: center; padding: 40px; color: #6b7280;">
                            No clients loaded. Please upload an Excel database or add clients manually.
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = clients.map(client => `
                <tr>
                    <td><strong>${client.name}</strong></td>
                    <td>${client.matterNumber}</td>
                    <td>${client.court}</td>
                    <td>${client.charges}</td>
                    <td><span class="status-badge status-${client.status.toLowerCase()}">${client.status}</span></td>
                    <td>${client.ccl ? '✅' : '❌'}</td>
                    <td>${client.mention ? '✅' : '❌'}</td>
                    <td>${client.final ? '✅' : '❌'}</td>
                    <td>${client.nextCourt ? formatDate(client.nextCourt) : 'TBD'}</td>
                    <td>
                        <button class="btn btn-primary" style="padding: 6px 12px; font-size: 12px;" onclick="selectClientForLetter(${client.id})">Generate Letter</button>
                    </td>
                </tr>
            `).join('');
        }
        
        // Load client select dropdown
        function loadClientSelect() {
            const select = document.getElementById('clientSelect');
            if (!select) return;
            
            select.innerHTML = '<option value="">-- Select a Client --</option>';
            
            clients.forEach(client => {
                const option = document.createElement('option');
                option.value = client.id;
                option.textContent = `${client.name} (${client.matterNumber})`;
                select.appendChild(option);
            });
        }
        
        // Load CDR client select dropdown
        function loadCDRClientSelect() {
            const select = document.getElementById('cdrClientSelect');
            if (!select) return;
            
            select.innerHTML = '<option value="">-- Manual Entry --</option>';
            
            clients.forEach(client => {
                const option = document.createElement('option');
                option.value = client.id;
                option.textContent = `${client.name} (${client.matterNumber})`;
                select.appendChild(option);
            });
        }
        
        // Update analytics dashboard
        function updateAnalytics() {
            const totalMattersEl = document.getElementById('totalMatters');
            const activeMattersEl = document.getElementById('activeMatters');
            const pendingLettersEl = document.getElementById('pendingLetters');
            const upcomingCourtEl = document.getElementById('upcomingCourt');
            
            if (totalMattersEl) totalMattersEl.textContent = clients.length;
            if (activeMattersEl) activeMattersEl.textContent = clients.filter(c => c.status === 'Active').length;
            
            // Count pending letters (clients without CCL)
            const pendingLetters = clients.filter(c => !c.ccl).length;
            if (pendingLettersEl) pendingLettersEl.textContent = pendingLetters;
            
            // Count upcoming court dates (next 7 days)
            const nextWeek = new Date();
            nextWeek.setDate(nextWeek.getDate() + 7);
            const upcoming = clients.filter(c => {
                if (!c.nextCourt) return false;
                const courtDate = new Date(c.nextCourt);
                return courtDate <= nextWeek && courtDate >= new Date();
            }).length;
            if (upcomingCourtEl) upcomingCourtEl.textContent = upcoming;
            
            // Court breakdown
            const courtBreakdown = {};
            clients.forEach(c => {
                courtBreakdown[c.court] = (courtBreakdown[c.court] || 0) + 1;
            });
            
            const courtDiv = document.getElementById('courtBreakdown');
            if (courtDiv) {
                courtDiv.innerHTML = Object.entries(courtBreakdown)
                    .sort((a, b) => b[1] - a[1])
                    .map(([court, count]) => `
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #e5e7eb;">
                            <span>${court}</span>
                            <strong>${count}</strong>
                        </div>
                    `).join('') || '<p style="color: #6b7280;">No data available</p>';
            }
            
            // Letter status chart
            const statusDiv = document.getElementById('letterStatusChart');
            if (statusDiv) {
                const cclSent = clients.filter(c => c.ccl).length;
                const mentionSent = clients.filter(c => c.mention).length;
                const finalSent = clients.filter(c => c.final).length;
                
                statusDiv.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                        <div style="text-align: center;">
                            <div style="font-size: 2em; font-weight: bold; color: #3b82f6;">${cclSent}</div>
                            <div>CCL Sent</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2em; font-weight: bold; color: #16a34a;">${mentionSent}</div>
                            <div>Mention Letters</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2em; font-weight: bold; color: #dc2626;">${finalSent}</div>
                            <div>Final Letters</div>
                        </div>
                    </div>
                `;
            }
        }
        
        // ===================================================================
        // NAVIGATION FUNCTIONS
        // ===================================================================
        
        // Switch between tabs
        function switchTab(tabName, event) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            var tabElement = document.getElementById(tabName);
            if (tabElement) {
                tabElement.classList.add('active');
            }
            if (event && event.target) {
                event.target.classList.add('active');
            }
            
            if (tabName === 'analytics') {
                updateAnalytics();
            }
        }
        
        // ===================================================================
        // MODAL FUNCTIONS
        // ===================================================================
        
        // Open add client modal
        function openModal() {
            document.getElementById('addClientModal').style.display = 'block';
        }
        
        // Close add client modal
        function closeModal() {
            document.getElementById('addClientModal').style.display = 'none';
            document.getElementById('addClientForm').reset();
        }
        
        // ===================================================================
        // CLIENT MANAGEMENT FUNCTIONS
        // ===================================================================
        
        // Add new client
        function addClient(event) {
            event.preventDefault();
            
            const newClient = {
                id: clients.length > 0 ? Math.max(...clients.map(c => c.id)) + 1 : 1,
                name: document.getElementById('newClientName').value,
                address: document.getElementById('newClientAddress').value,
                matterNumber: document.getElementById('newMatterNumber').value,
                court: document.getElementById('newCourt').value,
                matterType: document.getElementById('newMatterType').value,
                charges: document.getElementById('newCharges').value,
                legalAid: document.getElementById('newLegalAid').value === 'Yes',
                nextCourt: document.getElementById('newNextCourt').value,
                status: 'Active',
                ccl: false,
                mention: false,
                final: false,
                letterHistory: []
            };
            
            clients.push(newClient);
            saveData();
            updateUI();
            closeModal();
            
            alert('Client added successfully!');
        }
        
        // Select client for letter from master list
        function selectClientForLetter(clientId) {
            // Switch to generator tab
            const generatorTab = document.querySelector('.tab:nth-child(2)');
            if (generatorTab) {
                generatorTab.click();
            }
            document.getElementById('clientSelect').value = clientId;
            loadClientInfo();
        }
        
        // ===================================================================
        // CDR FUNCTIONS
        // ===================================================================
        
        // Load CDR client info
        function loadCDRClientInfo() {
            const clientId = parseInt(document.getElementById('cdrClientSelect').value);
            
            if (!clientId) {
                // Clear fields for manual entry
                document.getElementById('cdrClientName').value = '';
                document.getElementById('cdrFileNumber').value = '';
                document.getElementById('cdrCourt').value = '';
                document.getElementById('cdrOutcomeCourt').value = '';
                return;
            }
            
            const client = clients.find(c => c.id === clientId);
            if (!client) return;
            
            // Populate CDR fields
            document.getElementById('cdrClientName').value = client.name;
            document.getElementById('cdrFileNumber').value = client.matterNumber;
            document.getElementById('cdrCourt').value = client.court;
            document.getElementById('cdrOutcomeCourt').value = client.court;
            
            // If client has next court date, populate that too
            if (client.nextCourt) {
                document.getElementById('cdrCourtDate').value = client.nextCourt;
            }
        }
        
        // Get allocated to checkboxes
        function getAllocatedTo() {
            const allocated = [];
            document.querySelectorAll('input[id^="allocate_"]:checked').forEach(cb => {
                allocated.push(cb.value);
            });
            return allocated.join(', ') || 'TBD';
        }
        
        // Get letter allocated to
        function getLetterAllocatedTo() {
            const allocated = [];
            document.querySelectorAll('input[id^="letter_allocate_"]:checked').forEach(cb => {
                allocated.push(cb.value);
            });
            return allocated.join(', ') || 'TBD';
        }
        
        // Format CDR text
        function formatCDRText(cdrData) {
            let text = "** ** ** ** **COURT OUTCOME** ** ** **\n";
            text += `COURT: ${cdrData.outcomeCourt}\n`;
            text += `DATE: ${formatDate(cdrData.outcomeDate)}\n`;
            text += `CORAM: \n`;
            text += `CROWN: \n`;
            text += `START: ${cdrData.startTime}\n`;
            text += `FINISH: ${cdrData.finishTime}\n\n`;
            
            text += "**COURT DIARY REQUEST**\n";
            text += `COURT DATE: ${formatDate(cdrData.courtDate)}\n`;
            text += `SOLICITOR: ${cdrData.solicitor}\n`;
            text += `CLIENT: ${cdrData.clientName}\n`;
            text += `FILE NUMBER: ${cdrData.fileNumber}\n`;
            text += `REASON: ${cdrData.reason}\n`;
            text += `COURT: ${cdrData.court}\n`;
            text += `COURT TIME: ${cdrData.courtTime}\n`;
            text += `ALLOCATE TO: ${cdrData.allocateTo}\n`;
            text += `CLIENT EXCUSED: ${cdrData.clientExcused ? 'Yes' : 'No'}\n`;
            text += `FEE REMINDER: ${cdrData.feeReminder || 'N/A'}`;
            
            return text;
        }
        
        // Format CDR as HTML (matching Outlook template)
        function formatCDRHTML(cdrData) {
            return `
            <div style="font-family: Arial, sans-serif; font-size: 10pt; color: black;">
                <p style="text-align: center; font-weight: bold; margin: 20px 0;">COURT OUTCOME</p>
                
                <table style="border-collapse: collapse; width: 100%; max-width: 650px;">
                    <tr>
                        <td style="width: 30%; padding: 5px 10px; font-weight: bold;">COURT:</td>
                        <td style="width: 70%; padding: 5px 10px;">${cdrData.outcomeCourt || ''}</td>
                    </tr>
                    <tr>
                        <td style="width: 30%; padding: 5px 10px; font-weight: bold;">DATE:</td>
                        <td style="width: 70%; padding: 5px 10px;">${formatDate(cdrData.outcomeDate) || ''}</td>
                    </tr>
                    <tr>
                        <td style="width: 30%; padding: 5px 10px; font-weight: bold;">CORAM:</td>
                        <td style="width: 70%; padding: 5px 10px;"></td>
                    </tr>
                    <tr>
                        <td style="width: 30%; padding: 5px 10px; font-weight: bold;">CROWN:</td>
                        <td style="width: 70%; padding: 5px 10px;"></td>
                    </tr>
                    <tr>
                        <td style="width: 30%; padding: 5px 10px; font-weight: bold;">START:</td>
                        <td style="width: 70%; padding: 5px 10px;">${cdrData.startTime || ''}</td>
                    </tr>
                    <tr>
                        <td style="width: 30%; padding: 5px 10px; font-weight: bold;">FINISH:</td>
                        <td style="width: 70%; padding: 5px 10px;">${cdrData.finishTime || ''}</td>
                    </tr>
                </table>
                
                <p style="text-align: center; font-weight: bold; margin: 20px 0;">COURT DIARY REQUEST</p>
                
                <table style="border-collapse: collapse; width: 100%; max-width: 650px;">
                    <tr>
                        <td style="width: 30%; padding: 5px 10px; font-weight: bold;">COURT DATE:</td>
                        <td style="width: 70%; padding: 5px 10px;">${formatDate(cdrData.courtDate) || ''}</td>
                    </tr>
                    <tr>
                        <td style="width: 30%; padding: 5px 10px; font-weight: bold;">SOLICITOR:</td>
                        <td style="width: 70%; padding: 5px 10px;">${cdrData.solicitor || ''}</td>
                    </tr>
                    <tr>
                        <td style="width: 30%; padding: 5px 10px; font-weight: bold;">CLIENT:</td>
                        <td style="width: 70%; padding: 5px 10px;">${cdrData.clientName || ''}</td>
                    </tr>
                    <tr>
                        <td style="width: 30%; padding: 5px 10px; font-weight: bold;">FILE NUMBER:</td>
                        <td style="width: 70%; padding: 5px 10px;">${cdrData.fileNumber || ''}</td>
                    </tr>
                    <tr>
                        <td style="width: 30%; padding: 5px 10px; font-weight: bold;">REASON:</td>
                        <td style="width: 70%; padding: 5px 10px;">${cdrData.reason || ''}</td>
                    </tr>
                    <tr>
                        <td style="width: 30%; padding: 5px 10px; font-weight: bold;">COURT:</td>
                        <td style="width: 70%; padding: 5px 10px;">${cdrData.court || ''}</td>
                    </tr>
                    <tr>
                        <td style="width: 30%; padding: 5px 10px; font-weight: bold;">COURT TIME:</td>
                        <td style="width: 70%; padding: 5px 10px;">${cdrData.courtTime || ''}</td>
                    </tr>
                    <tr>
                        <td style="width: 30%; padding: 5px 10px; font-weight: bold;">ALLOCATE TO:</td>
                        <td style="width: 70%; padding: 5px 10px;">${cdrData.allocateTo || ''}</td>
                    </tr>
                    <tr>
                        <td style="width: 30%; padding: 5px 10px; font-weight: bold;">CLIENT EXCUSED:</td>
                        <td style="width: 70%; padding: 5px 10px;">${cdrData.clientExcused ? 'Yes' : 'No'}</td>
                    </tr>
                    <tr>
                        <td style="width: 30%; padding: 5px 10px; font-weight: bold;">FEE REMINDER:</td>
                        <td style="width: 70%; padding: 5px 10px;">${cdrData.feeReminder || ''}</td>
                    </tr>
                </table>
            </div>`;
        }
        
        // Generate CDR
        function generateCDR() {
            const cdrData = {
                outcomeCourt: document.getElementById('cdrOutcomeCourt').value,
                outcomeDate: document.getElementById('cdrOutcomeDate').value,
                startTime: document.getElementById('cdrStartTime').value,
                finishTime: document.getElementById('cdrFinishTime').value,
                courtDate: document.getElementById('cdrCourtDate').value,
                solicitor: document.getElementById('cdrSolicitor').value,
                clientName: document.getElementById('cdrClientName').value,
                fileNumber: document.getElementById('cdrFileNumber').value,
                reason: document.getElementById('cdrReason').value,
                court: document.getElementById('cdrCourt').value,
                courtTime: document.getElementById('cdrCourtTime').value,
                allocateTo: getAllocatedTo(),
                clientExcused: document.getElementById('cdrClientExcused').checked,
                feeReminder: document.getElementById('cdrFeeReminder').value
            };
            
            currentCDRData = cdrData;
            
            let cdrText = formatCDRText(cdrData);
            
            const outputDiv = document.getElementById('cdrOutput');
            outputDiv.textContent = cdrText;
            outputDiv.style.display = 'block';
        }
        
        // Send CDR to Zapier
        function sendCDRToZapier() {
            if (!currentCDRData) {
                alert('Please generate a CDR first');
                return;
            }
            
            const statusDiv = document.getElementById('cdrZapierStatus');
            statusDiv.style.display = 'block';
            statusDiv.style.backgroundColor = '#fef3c7';
            statusDiv.style.color = '#92400e';
            statusDiv.textContent = 'Sending CDR to Zapier...';
            
            // Prepare payload with CDR data only
            const payload = {
                type: 'CDR_ONLY',
                letterData: null,
                cdrData: {
                    outcomeCourt: currentCDRData.outcomeCourt,
                    outcomeDate: currentCDRData.outcomeDate,
                    startTime: currentCDRData.startTime,
                    finishTime: currentCDRData.finishTime,
                    courtDate: currentCDRData.courtDate,
                    solicitor: currentCDRData.solicitor,
                    clientName: currentCDRData.clientName,
                    fileNumber: currentCDRData.fileNumber,
                    reason: currentCDRData.reason,
                    court: currentCDRData.court,
                    courtTime: currentCDRData.courtTime,
                    allocateTo: currentCDRData.allocateTo,
                    clientExcused: currentCDRData.clientExcused,
                    feeReminder: currentCDRData.feeReminder,
                    cdrText: formatCDRText(currentCDRData),
                    cdrHTML: formatCDRHTML(currentCDRData)
                },
                hasLetter: false,
                hasCDR: true
            };
            
            const formData = new FormData();
            formData.append('data', JSON.stringify(payload));
            
            fetch('https://hooks.zapier.com/hooks/catch/19713185/u47xnci/', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    statusDiv.style.backgroundColor = '#d4edda';
                    statusDiv.style.color = '#155724';
                    statusDiv.textContent = '✓ CDR successfully sent to Zapier!';
                    setTimeout(() => {
                        statusDiv.style.display = 'none';
                    }, 3000);
                } else {
                    throw new Error('Failed to send');
                }
            })
            .catch(error => {
                statusDiv.style.backgroundColor = '#f8d7da';
                statusDiv.style.color = '#721c24';
                statusDiv.textContent = '✗ Failed to send CDR to Zapier. Please try again.';
                console.error('Zapier error:', error);
            });
        }
        
        // Clear CDR form
        function clearCDRForm() {
            if (confirm('Clear all CDR fields?')) {
                document.getElementById('cdrClientSelect').value = '';
                document.getElementById('cdrOutcomeCourt').value = '';
                document.getElementById('cdrOutcomeDate').value = '';
                document.getElementById('cdrStartTime').value = '09:30';
                document.getElementById('cdrFinishTime').value = '10:00';
                document.getElementById('cdrCourtDate').value = '';
                document.getElementById('cdrSolicitor').value = 'AAG';
                document.getElementById('cdrClientName').value = '';
                document.getElementById('cdrFileNumber').value = '';
                document.getElementById('cdrReason').value = '';
                document.getElementById('cdrCourt').value = '';
                document.getElementById('cdrCourtTime').value = '09:30';
                document.getElementById('cdrClientExcused').checked = false;
                document.getElementById('cdrFeeReminder').value = '';
                
                // Clear all allocate checkboxes
                document.querySelectorAll('input[id^="allocate_"]').forEach(cb => cb.checked = false);
                
                document.getElementById('cdrOutput').style.display = 'none';
                currentCDRData = null;
            }
        }
        
        // ===================================================================
        // LETTER GENERATION FUNCTIONS
        // ===================================================================
        
        // Load client info for letter generation
        function loadClientInfo() {
            const clientId = parseInt(document.getElementById('clientSelect').value);
            const clientInfoSection = document.getElementById('clientInfoSection');
            
            if (!clientId) {
                clientInfoSection.style.display = 'none';
                return;
            }
            
            currentClient = clients.find(c => c.id === clientId);
            if (!currentClient) return;
            
            clientInfoSection.style.display = 'block';
            
            // Populate client info grid
            document.getElementById('clientInfoGrid').innerHTML = `
                <div class="info-item">
                    <div class="info-label">Client Name</div>
                    <div class="info-value">${currentClient.name}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Address</div>
                    <div class="info-value">${currentClient.address || 'Not provided'}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Matter Number</div>
                    <div class="info-value">${currentClient.matterNumber}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Court</div>
                    <div class="info-value">${currentClient.court}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Matter Type</div>
                    <div class="info-value">${currentClient.matterType}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Charges</div>
                    <div class="info-value">${currentClient.charges}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Legal Aid</div>
                    <div class="info-value">${currentClient.legalAid ? 'Yes' : 'No'}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Next Court</div>
                    <div class="info-value">${currentClient.nextCourt ? formatDate(currentClient.nextCourt) : 'TBD'}</div>
                </div>
            `;
            
            // Populate letter history
            const historyList = document.getElementById('letterHistoryList');
            if (currentClient.letterHistory && currentClient.letterHistory.length > 0) {
                historyList.innerHTML = currentClient.letterHistory.map(letter => `
                    <div class="letter-item">
                        <div>
                            <strong>${letter.type}</strong> - ${formatDate(letter.date)}
                            <br><small>${letter.notes || ''}</small>
                        </div>
                        <span class="status-badge status-completed">Sent</span>
                    </div>
                `).join('');
            } else {
                historyList.innerHTML = '<p style="color: #6b7280; font-style: italic;">No letters sent yet</p>';
            }
        }
        
        // Update letter fields
        function updateLetterFields() {
            const letterType = document.getElementById('letterType').value;
            const dynamicFields = document.getElementById('dynamicFields');
            const cdrSection = document.getElementById('cdrForLetterSection');
            
            if (!letterType || !currentClient) {
                dynamicFields.innerHTML = '';
                cdrSection.style.display = 'none';
                return;
            }
            
            // Show CDR section for all letter types
            cdrSection.style.display = 'block';
            
            let fieldsHTML = '';
            
            switch(letterType) {
                case 'CCL':
                    fieldsHTML = getCCLFields();
                    break;
                case 'Mention':
                    fieldsHTML = getMentionFields();
                    break;
                case 'Final':
                    fieldsHTML = getFinalFields();
                    break;
                case 'FeeReestimate':
                    fieldsHTML = getFeeReestimateFields();
                    break;
            }
            
            dynamicFields.innerHTML = fieldsHTML;
            
            // Initialize any conditional logic
            if (letterType === 'CCL') {
                toggleLegalAidFields();
                togglePleaOptions();
            }
        }
        
        // Toggle CDR fields in letter generation
        function toggleCDRFields() {
            const isChecked = document.getElementById('generateCDRWithLetter').checked;
            document.getElementById('cdrFieldsInLetter').style.display = isChecked ? 'block' : 'none';
        }
        
        // Generate prompt (stub - needs letter-specific prompt generation functions)
        function generatePrompt() {
            const letterType = document.getElementById('letterType').value;
            
            if (!letterType || !currentClient) {
                alert('Please select a client and letter type');
                return;
            }
            
            let prompt = `Generate ${letterType} letter for:\n`;
            prompt += `Client: ${currentClient.name}\n`;
            prompt += `Matter: ${currentClient.matterNumber}\n`;
            prompt += `Court: ${currentClient.court}\n`;
            prompt += `Charges: ${currentClient.charges}\n\n`;
            
            // Add specific letter content based on type
            prompt += `[Letter specific content would be generated here based on form inputs]\n`;
            
            let cdrData = null;
            
            // Check if CDR should be generated
            const generateCDR = document.getElementById('generateCDRWithLetter')?.checked;
            if (generateCDR) {
                const nextCourtDate = document.getElementById('nextCourtDate')?.value;
                if (nextCourtDate) {
                    cdrData = {
                        outcomeCourt: currentClient.court,
                        outcomeDate: getTodayDate(),
                        startTime: '09:30',
                        finishTime: '10:00',
                        courtDate: nextCourtDate,
                        solicitor: 'AAG',
                        clientName: currentClient.name,
                        fileNumber: currentClient.matterNumber,
                        reason: document.getElementById('letterCDRReason')?.value || 'Mention',
                        court: currentClient.court,
                        courtTime: '09:30',
                        allocateTo: getLetterAllocatedTo(),
                        clientExcused: document.getElementById('letterCDRClientExcused')?.checked || false,
                        feeReminder: ''
                    };
                }
            }
            
            // Add CDR to prompt if generated
            if (cdrData) {
                prompt += '\n\n--- CDR ALSO GENERATED ---\n';
                prompt += formatCDRText(cdrData);
                currentCDRData = cdrData;
            }
            
            const outputDiv = document.getElementById('promptOutput');
            outputDiv.textContent = prompt;
            outputDiv.style.display = 'block';
            
            // Update letter history
            if (!currentClient.letterHistory) currentClient.letterHistory = [];
            currentClient.letterHistory.push({
                type: letterType,
                date: new Date().toISOString().slice(0,10),
                notes: `Generated ${letterType} prompt${cdrData ? ' with CDR' : ''}`
            });
            
            // Update letter sent status
            switch(letterType) {
                case 'CCL':
                    currentClient.ccl = true;
                    break;
                case 'Mention':
                    currentClient.mention = true;
                    break;
                case 'Final':
                    currentClient.final = true;
                    break;
            }
            
            saveData();
            updateUI();
        }
        
        // Copy prompt to clipboard
        function copyPrompt() {
            const promptText = document.getElementById('promptOutput').textContent;
            if (!promptText) {
                alert('Please generate a prompt first');
                return;
            }
            
            navigator.clipboard.writeText(promptText).then(() => {
                alert('Prompt copied to clipboard!');
            }).catch(err => {
                // Fallback
                const textArea = document.createElement('textarea');
                textArea.value = promptText;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('Prompt copied to clipboard!');
            });
        }
        
        // Clear form
        function clearForm() {
            if (confirm('Clear all fields?')) {
                document.getElementById('letterType').value = '';
                document.getElementById('dynamicFields').innerHTML = '';
                document.getElementById('promptOutput').style.display = 'none';
            }
        }
        
        // Send to Zapier
        function sendToZapier() {
            const promptText = document.getElementById('promptOutput').textContent;
            const letterType = document.getElementById('letterType').value;
            
            if (!promptText || !currentClient || !letterType) {
                alert('Please generate a prompt first');
                return;
            }
            
            const statusDiv = document.getElementById('zapierStatus');
            statusDiv.style.display = 'block';
            statusDiv.style.backgroundColor = '#fef3c7';
            statusDiv.style.color = '#92400e';
            statusDiv.textContent = 'Sending to Zapier...';
            
            // Check if CDR is included
            const hasCDR = document.getElementById('generateCDRWithLetter')?.checked;
            
            // Prepare payload
            const payload = {
                type: hasCDR ? 'LETTER_AND_CDR' : letterType,
                letterData: {
                    letterType: letterType,
                    prompt: promptText,
                    clientName: currentClient.name,
                    matterNumber: currentClient.matterNumber,
                    court: currentClient.court,
                    templateFileName: getTemplateFileName(letterType)
                },
                cdrData: null,
                hasLetter: true,
                hasCDR: hasCDR
            };
            
            // Add CDR data if generated
            if (hasCDR && currentCDRData) {
                payload.cdrData = {
                    outcomeCourt: currentCDRData.outcomeCourt,
                    outcomeDate: currentCDRData.outcomeDate,
                    startTime: currentCDRData.startTime,
                    finishTime: currentCDRData.finishTime,
                    courtDate: currentCDRData.courtDate,
                    solicitor: currentCDRData.solicitor,
                    clientName: currentCDRData.clientName,
                    fileNumber: currentCDRData.fileNumber,
                    reason: currentCDRData.reason,
                    court: currentCDRData.court,
                    courtTime: currentCDRData.courtTime,
                    allocateTo: currentCDRData.allocateTo,
                    clientExcused: currentCDRData.clientExcused,
                    feeReminder: currentCDRData.feeReminder,
                    cdrText: formatCDRText(currentCDRData),
                    cdrHTML: formatCDRHTML(currentCDRData)
                };
            }
            
            // Create form data
            const formData = new FormData();
            formData.append('data', JSON.stringify(payload));
            
            fetch('https://hooks.zapier.com/hooks/catch/19713185/u47xnci/', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    statusDiv.style.backgroundColor = '#d4edda';
                    statusDiv.style.color = '#155724';
                    statusDiv.textContent = hasCDR ? 
                        '✓ Successfully sent letter and CDR to Zapier!' : 
                        '✓ Successfully sent to Zapier!';
                    setTimeout(() => {
                        statusDiv.style.display = 'none';
                    }, 3000);
                } else {
                    throw new Error('Failed to send');
                }
            })
            .catch(error => {
                statusDiv.style.backgroundColor = '#f8d7da';
                statusDiv.style.color = '#721c24';
                statusDiv.textContent = '✗ Failed to send to Zapier. Please try again.';
                console.error('Zapier error:', error);
            });
        }
        
        // Update Excel record
        function updateExcelRecord() {
            const letterType = document.getElementById('letterType').value;
            
            if (!currentClient || !letterType) {
                alert('Please select a client and generate a letter first');
                return;
            }
            
            // Update the client record
            const clientIndex = clients.findIndex(c => c.id === currentClient.id);
            if (clientIndex !== -1) {
                // Update letter sent status
                switch(letterType) {
                    case 'CCL':
                        clients[clientIndex].ccl = true;
                        break;
                    case 'Mention':
                        clients[clientIndex].mention = true;
                        break;
                    case 'Final':
                        clients[clientIndex].final = true;
                        break;
                }
                
                // Update last updated date
                clients[clientIndex].lastUpdated = new Date().toLocaleDateString('en-AU');
                
                // Save to localStorage
                saveData();
                
                // Update UI
                updateUI();
                
                // Export to Excel automatically
                exportToExcel();
                
                alert(`Excel database updated!\n${letterType} marked as sent for ${currentClient.name}`);
            }
        }
        
        // ===================================================================
        // EXCEL IMPORT/EXPORT FUNCTIONS
        // ===================================================================
        
        // Load Excel file
        function loadExcelFile() {
            const fileInput = document.getElementById('excelFile');
            const file = fileInput.files[0];
            
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    // Convert Excel data to our format
                    clients = jsonData.map((row, index) => ({
                        id: index + 1,
                        name: row['Client Name'] || '',
                        address: row['Address'] || '',
                        matterNumber: row['Matter Reference'] || '',
                        court: row['Court'] || '',
                        matterType: row['Matter Type'] || '',
                        charges: row['Charges'] || '',
                        legalAid: row['Legal Aid'] === 'Yes',
                        contribution: row['Contribution'] || '',
                        status: row['Status'] || 'Active',
                        ccl: row['CCL Sent'] === 'Yes' || false,
                        mention: row['Mention Sent'] === 'Yes' || false,
                        final: row['Final Sent'] === 'Yes' || false,
                        nextCourt: row['Next Court Date'] || '',
                        letterHistory: []
                    }));
                    
                    saveData();
                    updateUI();
                    updateDatabaseStatus(true);
                    alert(`Successfully loaded ${clients.length} clients from Excel`);
                } catch (error) {
                    alert('Error loading Excel file: ' + error.message);
                    console.error('Excel loading error:', error);
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        // Export to Excel
        function exportToExcel() {
            if (clients.length === 0) {
                alert('No data to export');
                return;
            }
            
            // Prepare data for export
            const exportData = clients.map(client => ({
                'Client Name': client.name,
                'Address': client.address,
                'Matter Reference': client.matterNumber,
                'Court': client.court,
                'Matter Type': client.matterType,
                'Charges': client.charges,
                'Legal Aid': client.legalAid ? 'Yes' : 'No',
                'Contribution': client.contribution || '',
                'Status': client.status,
                'CCL Sent': client.ccl ? 'Yes' : 'No',
                'Mention Sent': client.mention ? 'Yes' : 'No',
                'Final Sent': client.final ? 'Yes' : 'No',
                'Next Court Date': client.nextCourt,
                'Last Updated': new Date().toLocaleDateString('en-AU')
            }));
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(exportData);
            XLSX.utils.book_append_sheet(wb, ws, 'Clients');
            XLSX.writeFile(wb, `legal_clients_${new Date().toISOString().slice(0,10)}.xlsx`);
        }
        
        // ===================================================================
        // LETTER FIELD GENERATION FUNCTIONS
        // ===================================================================
        
        function getCCLFields() {
            return `
                <div class="section">
                    <div class="section-title">Contact Details</div>
                    
                    <div class="form-group">
                        <label for="contactMethod">Contact Method*</label>
                        <select id="contactMethod" required>
                            <option value="">Select Contact Method</option>
                            <option value="Office attendance">Office attendance</option>
                            <option value="Phone call">Phone call</option>
                            <option value="Email">Email</option>
                            <option value="Police station">Police station</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="contactDate">Contact Date*</label>
                        <input type="date" id="contactDate" value="${getTodayDate()}" required>
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-title">Charges</div>
                    
                    <div class="charges-section">
                        <div class="charges-category">
                            <h4>Violence Offences</h4>
                            <div class="checkbox-group">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="charge_affray" value="Affray - s93C Crimes Act">
                                    <label for="charge_affray">Affray - s93C Crimes Act</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="charge_assault" value="Common Assault - s61 Crimes Act">
                                    <label for="charge_assault">Common Assault - s61 Crimes Act</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="charge_abh" value="Assault occasioning ABH - s59 Crimes Act">
                                    <label for="charge_abh">Assault occasioning ABH - s59</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="charge_assault_police" value="Assault Police - s60 Crimes Act">
                                    <label for="charge_assault_police">Assault Police - s60 Crimes Act</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="charge_resist" value="Resist Officer - s58 Crimes Act">
                                    <label for="charge_resist">Resist Officer - s58 Crimes Act</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="charges-category">
                            <h4>Domestic Violence</h4>
                            <div class="checkbox-group">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="charge_breach_avo" value="Breach AVO - s14 CDPV Act">
                                    <label for="charge_breach_avo">Breach AVO - s14 CDPV Act</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="charge_stalk" value="Stalk/Intimidate - s13 CDPV Act">
                                    <label for="charge_stalk">Stalk/Intimidate - s13 CDPV Act</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="charge_destroy" value="Destroy/Damage Property - s195 Crimes Act">
                                    <label for="charge_destroy">Destroy/Damage Property - s195</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="charges-category">
                            <h4>Traffic Offences</h4>
                            <div class="checkbox-group">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="charge_low_pca" value="Low Range PCA - s110(3) Road Transport Act">
                                    <label for="charge_low_pca">Low Range PCA - s110(3)</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="charge_mid_pca" value="Mid Range PCA - s110(4) Road Transport Act">
                                    <label for="charge_mid_pca">Mid Range PCA - s110(4)</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="charge_high_pca" value="High Range PCA - s110(5) Road Transport Act">
                                    <label for="charge_high_pca">High Range PCA - s110(5)</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="charge_disqualified" value="Drive whilst disqualified - s54(1) Road Transport Act">
                                    <label for="charge_disqualified">Drive whilst disqualified - s54(1)</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="charge_suspended" value="Drive whilst suspended - s54(1) Road Transport Act">
                                    <label for="charge_suspended">Drive whilst suspended - s54(1)</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="charges-category">
                            <h4>Drug Offences</h4>
                            <div class="checkbox-group">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="charge_possess" value="Possess Prohibited Drug - s10 DMTA">
                                    <label for="charge_possess">Possess Prohibited Drug - s10</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="charge_supply" value="Supply Prohibited Drug - s25 DMTA">
                                    <label for="charge_supply">Supply Prohibited Drug - s25</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="charges-category">
                            <h4>Property Offences</h4>
                            <div class="checkbox-group">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="charge_larceny" value="Larceny - s117 Crimes Act">
                                    <label for="charge_larceny">Larceny - s117 Crimes Act</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="charge_goods" value="Goods in Custody - s527C Crimes Act">
                                    <label for="charge_goods">Goods in Custody - s527C</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="additionalCharges">Additional Charges</label>
                        <input type="text" id="additionalCharges" placeholder="Enter any additional charges">
                    </div>
                    
                    <div class="form-group">
                        <label for="counts">Number of Counts</label>
                        <input type="number" id="counts" min="1" placeholder="e.g., 3">
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-title">Legal Aid & Fees</div>
                    
                    <div class="form-group">
                        <label for="legalAidStatus">Legal Aid?*</label>
                        <select id="legalAidStatus" onchange="toggleLegalAidFields()" required>
                            <option value="">Select</option>
                            <option value="Yes" ${currentClient && currentClient.legalAid ? 'selected' : ''}>Yes</option>
                            <option value="No" ${currentClient && !currentClient.legalAid ? 'selected' : ''}>No</option>
                        </select>
                    </div>
                    
                    <div class="conditional" id="legalAidDetails">
                        <div class="form-group">
                            <label for="contribution">Contribution Amount ($)</label>
                            <input type="number" id="contribution" placeholder="Leave blank if no contribution">
                        </div>
                    </div>
                    
                    <div class="conditional" id="privateDetails">
                        <div class="form-group">
                            <label for="estimate">Estimate Amount ($)*</label>
                            <input type="number" id="estimate" placeholder="e.g., 3500">
                        </div>
                        <div class="form-group">
                            <label for="depositPaid">Deposit Paid?</label>
                            <select id="depositPaid" onchange="toggleDepositAmount()">
                                <option value="No">No</option>
                                <option value="Yes">Yes</option>
                            </select>
                        </div>
                        <div class="conditional" id="depositDetails">
                            <div class="form-group">
                                <label for="depositAmount">Deposit Amount ($)</label>
                                <input type="number" id="depositAmount" placeholder="e.g., 1000">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-title">Instructions</div>
                    
                    <div class="form-group">
                        <label for="plea">Plea*</label>
                        <select id="plea" onchange="togglePleaOptions()" required>
                            <option value="">Select Plea</option>
                            <option value="Guilty">Guilty</option>
                            <option value="Not Guilty">Not Guilty</option>
                            ${currentClient && currentClient.matterType === 'Criminal - Indictable' ? '<option value="No plea yet (indictable)">No plea yet (indictable)</option>' : ''}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="clientInstructions">Client Instructions*</label>
                        <textarea id="clientInstructions" placeholder="What are the client's instructions moving forward?" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="nextCourtDate">Next Court Date</label>
                        <input type="date" id="nextCourtDate" value="${currentClient && currentClient.nextCourt ? currentClient.nextCourt : ''}">
                    </div>
                    
                    <div class="form-group">
                        <label for="requiredAttend">Client Required to Attend?</label>
                        <select id="requiredAttend">
                            <option value="">Select</option>
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                        </select>
                    </div>
                    
                    <div class="conditional" id="sentenceMaterials">
                        <label>Sentence Materials Discussed</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="mat_references" value="Character references">
                                <label for="mat_references">Character references</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="mat_psych_existing" value="Psych report - existing doctor">
                                <label for="mat_psych_existing">Psych report - existing doctor</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="mat_psych_referral" value="Psych report - need referral">
                                <label for="mat_psych_referral">Psych report - need referral</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="mat_traffic" value="Traffic Offenders Program">
                                <label for="mat_traffic">Traffic Offenders Program</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="mat_treatment" value="Drug/Alcohol treatment">
                                <label for="mat_treatment">Drug/Alcohol treatment</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="mat_other" value="Other treatment proof">
                                <label for="mat_other">Other treatment proof</label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-title">Additional Information</div>
                    <div class="form-group">
                        <label for="additionalInfo">Additional Information</label>
                        <textarea id="additionalInfo" placeholder="Any other relevant information for this letter"></textarea>
                    </div>
                </div>
            `;
        }
        
        function getMentionFields() {
            return `
                <div class="section">
                    <div class="section-title">Mention Letter Details</div>
                    
                    <div class="form-group">
                        <label for="mentionDate">Mention Date*</label>
                        <input type="date" id="mentionDate" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="mentionTime">Mention Time*</label>
                        <input type="time" id="mentionTime" value="09:30" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="mentionOutcome">Expected Outcome*</label>
                        <select id="mentionOutcome" required>
                            <option value="">Select Expected Outcome</option>
                            <option value="Adjournment">Adjournment</option>
                            <option value="Brief service">Brief service</option>
                            <option value="Negotiations">Negotiations</option>
                            <option value="Plea of guilty">Plea of guilty</option>
                            <option value="Plea of not guilty">Plea of not guilty</option>
                            <option value="Sentence">Sentence</option>
                            <option value="Set for hearing">Set for hearing</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="briefServed">Brief Served?</label>
                        <select id="briefServed">
                            <option value="">Select</option>
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                            <option value="Partial">Partial</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="negotiationsUpdate">Negotiations Update</label>
                        <textarea id="negotiationsUpdate" placeholder="Any updates on negotiations with prosecution"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="clientAttendance">Client Required to Attend?*</label>
                        <select id="clientAttendance" required>
                            <option value="">Select</option>
                            <option value="Yes">Yes - mandatory</option>
                            <option value="No">No - excused</option>
                            <option value="Preferred">Preferred but not mandatory</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="documentsRequired">Documents to Bring</label>
                        <textarea id="documentsRequired" placeholder="List any documents the client should bring"></textarea>
                    </div>
                </div>
            `;
        }
        
        function getFinalFields() {
            return `
                <div class="section">
                    <div class="section-title">Final Letter Details</div>
                    
                    <div class="form-group">
                        <label for="finalOutcome">Case Outcome*</label>
                        <select id="finalOutcome" onchange="checkPenaltyType()" required>
                            <option value="">Select Outcome</option>
                            <option value="Not Guilty">Not Guilty</option>
                            <option value="Charges dismissed">Charges dismissed</option>
                            <option value="Section 10 dismissal">Section 10 dismissal</option>
                            <option value="CRO without conviction">CRO without conviction</option>
                            <option value="CRO with conviction">CRO with conviction</option>
                            <option value="Fine only">Fine only</option>
                            <option value="CCO">Community Correction Order</option>
                            <option value="ICO">Intensive Correction Order</option>
                            <option value="Suspended sentence">Suspended sentence</option>
                            <option value="Full time custody">Full time custody</option>
                        </select>
                    </div>
                    
                    <div class="conditional" id="penaltyDetails">
                        <div class="form-group">
                            <label for="penaltyLength">Penalty Length</label>
                            <input type="text" id="penaltyLength" placeholder="e.g., 12 months, $1500">
                        </div>
                        
                        <div class="form-group" id="conditionsField" style="display: none;">
                            <label for="conditions">Conditions</label>
                            <textarea id="conditions" placeholder="List any conditions imposed"></textarea>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="criminalRecord">Criminal Record Impact</label>
                        <select id="criminalRecord">
                            <option value="">Select</option>
                            <option value="No conviction recorded">No conviction recorded</option>
                            <option value="Conviction recorded">Conviction recorded</option>
                            <option value="Spent conviction">Will become spent conviction</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="appealDeadline">Appeal Deadline</label>
                        <input type="date" id="appealDeadline">
                    </div>
                    
                    <div class="form-group">
                        <label for="costsOrder">Costs Order</label>
                        <select id="costsOrder">
                            <option value="">Select</option>
                            <option value="No costs">No costs order</option>
                            <option value="Pay prosecution costs">Pay prosecution costs</option>
                            <option value="Costs dismissed">Professional costs dismissed</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="finalBill">Final Bill Amount ($)</label>
                        <input type="number" id="finalBill" placeholder="Total legal costs">
                    </div>
                    
                    <div class="form-group">
                        <label for="outstandingAmount">Outstanding Amount ($)</label>
                        <input type="number" id="outstandingAmount" placeholder="Amount still owed">
                    </div>
                </div>
            `;
        }
        
        function getFeeReestimateFields() {
            return `
                <div class="section">
                    <div class="section-title">Fee Re-estimate Details</div>
                    
                    <div class="form-group">
                        <label for="originalEstimate">Original Estimate ($)*</label>
                        <input type="number" id="originalEstimate" placeholder="e.g., 3500" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="workCompleted">Work Completed to Date ($)*</label>
                        <input type="number" id="workCompleted" placeholder="e.g., 2500" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="revisedEstimate">Revised Total Estimate ($)*</label>
                        <input type="number" id="revisedEstimate" placeholder="e.g., 5500" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="reasonForIncrease">Reason for Increase*</label>
                        <textarea id="reasonForIncrease" required placeholder="Explain why costs have increased"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="additionalWork">Additional Work Required*</label>
                        <textarea id="additionalWork" required placeholder="Describe additional work needed"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="paymentRequired">Additional Payment Required ($)</label>
                        <input type="number" id="paymentRequired" placeholder="Amount needed to continue">
                    </div>
                    
                    <div class="form-group">
                        <label for="paymentDue">Payment Due Date</label>
                        <input type="date" id="paymentDue">
                    </div>
                </div>
            `;
        }
        
        // Toggle functions for form interactions
        function toggleLegalAidFields() {
            const legalAid = document.getElementById('legalAidStatus');
            if (!legalAid) return;
            
            const legalAidValue = legalAid.value;
            const legalAidDetails = document.getElementById('legalAidDetails');
            const privateDetails = document.getElementById('privateDetails');
            
            if (legalAidDetails) legalAidDetails.style.display = legalAidValue === 'Yes' ? 'block' : 'none';
            if (privateDetails) privateDetails.style.display = legalAidValue === 'No' ? 'block' : 'none';
        }
        
        function toggleDepositAmount() {
            const depositPaid = document.getElementById('depositPaid');
            const depositDetails = document.getElementById('depositDetails');
            if (depositPaid && depositDetails) {
                depositDetails.style.display = depositPaid.value === 'Yes' ? 'block' : 'none';
            }
        }
        
        function togglePleaOptions() {
            const plea = document.getElementById('plea');
            const materials = document.getElementById('sentenceMaterials');
            if (plea && materials) {
                materials.style.display = plea.value === 'Guilty' ? 'block' : 'none';
            }
        }
        
        function checkPenaltyType() {
            const outcome = document.getElementById('finalOutcome');
            const details = document.getElementById('penaltyDetails');
            const conditions = document.getElementById('conditionsField');
            
            if (!outcome) return;
            
            const outcomeValue = outcome.value;
            if (details) {
                if (outcomeValue && outcomeValue !== 'Not Guilty' && outcomeValue !== 'Charges dismissed') {
                    details.style.display = 'block';
                    if (conditions) {
                        conditions.style.display = (outcomeValue.includes('CRO') || outcomeValue.includes('CCO') || outcomeValue.includes('ICO')) ? 'block' : 'none';
                    }
                } else {
                    details.style.display = 'none';
                }
            }
        }
        
        // ===================================================================
        // INITIALIZATION
        // ===================================================================
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadSavedData();
            updateUI();
        });
        
        // Click outside modal to close
        window.onclick = function(event) {
            const modal = document.getElementById('addClientModal');
            if (event.target === modal) {
                closeModal();
            }
        }
    </script>
    
    <style>
        /* Your existing styles here - keeping them as is */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f8fafc;
            color: #1e293b;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 20px;
            background: white;
            border-radius: 8px;
            padding: 4px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            color: #64748b;
        }
        
        .tab.active {
            background: #3b82f6;
            color: white;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
        }
        
        .tab:hover:not(.active) {
            background: #e2e8f0;
            color: #475569;
        }
        
        .tab-content {
            display: none;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .tab-content.active {
            display: block;
        }
        
        .master-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .master-table th {
            background: #f1f5f9;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #475569;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .master-table td {
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .master-table tr:hover {
            background: #f8fafc;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-active { background: #dcfce7; color: #166534; }
        .status-waiting { background: #fef3c7; color: #92400e; }
        .status-completed { background: #dbeafe; color: #1e40af; }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }
        
        .form-group select,
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        
        .form-group select:focus,
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 12px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            transition: all 0.2s;
        }
        
        .checkbox-item:hover {
            border-color: #3b82f6;
            background: #f8fafc;
        }
        
        .checkbox-item input[type="checkbox"],
        .checkbox-item input[type="radio"] {
            width: auto;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            margin-right: 10px;
        }
        
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .output-box {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .client-info {
            background: #f0f9ff;
            border: 2px solid #0284c7;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }
        
        .client-info h3 {
            margin: 0 0 12px 0;
            color: #0284c7;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }
        
        .info-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .info-label {
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .info-value {
            font-weight: 500;
            color: #1f2937;
        }
        
        .section {
            border-top: 2px solid #eee;
            margin-top: 25px;
            padding-top: 20px;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 15px;
        }
        
        .database-status {
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 4px;
            text-align: center;
            font-weight: bold;
        }
        
        .status-connected {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .letter-history {
            background: #f9fafb;
            border-radius: 8px;
            padding: 16px;
            margin-top: 20px;
        }
        
        .letter-history h4 {
            margin: 0 0 12px 0;
            color: #374151;
        }
        
        .letter-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .letter-item:last-child {
            border-bottom: none;
        }
        
        .add-client-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #3b82f6;
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
            transition: all 0.2s;
        }
        
        .add-client-btn:hover {
            background: #2563eb;
            transform: scale(1.1);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 12px;
            padding: 30px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #6b7280;
        }
        
        .close:hover {
            color: #374151;
        }
        
        .cdr-checkbox {
            background: #fef3c7;
            border: 2px solid #fbbf24;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .cdr-checkbox label {
            font-weight: 600;
            color: #92400e;
        }
        
        .charges-section {
            background: #f9fafb;
            border-radius: 8px;
            padding: 16px;
            margin-top: 12px;
        }
        
        .charges-category {
            margin-bottom: 20px;
        }
        
        .charges-category h4 {
            color: #374151;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .multi-select {
            min-height: 120px;
        }
        
        .conditional {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background-color: #f0f8ff;
            border-radius: 8px;
            border: 1px solid #e0e7ff;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Legal Letter Generation System</h1>
            <p>Streamlined client matter management and automated Claude prompt generation</p>
        </div>
        
        <div class="database-status" id="databaseStatus">
            Database: Not Connected
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('master', event)">Master Client List</button>
            <button class="tab" onclick="switchTab('generator', event)">Letter Generator</button>
            <button class="tab" onclick="switchTab('cdr', event)">CDR</button>
            <button class="tab" onclick="switchTab('analytics', event)">Analytics</button>
        </div>
        
        <!-- Master Client List Tab -->
        <div id="master" class="tab-content active">
            <h2>Active Client Matters</h2>
            <p>Manage your active matters and track letter status</p>
            
            <table class="master-table" id="clientTable">
                <thead>
                    <tr>
                        <th>Client Name</th>
                        <th>Matter #</th>
                        <th>Court</th>
                        <th>Charges</th>
                        <th>Status</th>
                        <th>CCL</th>
                        <th>Mention</th>
                        <th>Final</th>
                        <th>Next Court</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="clientTableBody">
                    <tr>
                        <td colspan="10" style="text-align: center; padding: 40px; color: #6b7280;">
                            No clients loaded. Please upload an Excel database or add clients manually.
                        </td>
                    </tr>
                </tbody>
            </table>
            
            <div style="margin-top: 20px;">
                <input type="file" id="excelFile" accept=".xlsx,.xls,.csv" onchange="loadExcelFile()" style="display: none;">
                <button class="btn btn-primary" onclick="document.getElementById('excelFile').click()">
                    Upload Excel Database
                </button>
                <button class="btn btn-secondary" onclick="exportToExcel()">
                    Export to Excel
                </button>
            </div>
        </div>
        
        <!-- Letter Generator Tab -->
        <div id="generator" class="tab-content">
            <h2>Generate Letter Prompt</h2>
            
            <div class="form-group">
                <label for="clientSelect">Select Client:</label>
                <select id="clientSelect" onchange="loadClientInfo()">
                    <option value="">-- Select a Client --</option>
                </select>
            </div>
            
            <div id="clientInfoSection" style="display: none;">
                <div class="client-info">
                    <h3>Client Information</h3>
                    <div class="info-grid" id="clientInfoGrid">
                        <!-- Auto-populated from selection -->
                    </div>
                </div>
                
                <div class="letter-history" id="letterHistorySection">
                    <h4>Letter History</h4>
                    <div id="letterHistoryList">
                        <!-- Auto-populated -->
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="letterType">Letter Type:</label>
                    <select id="letterType" onchange="updateLetterFields()">
                        <option value="">-- Select Letter Type --</option>
                        <option value="CCL">Client Care Letter (CCL)</option>
                        <option value="Mention">Mention Letter</option>
                        <option value="Final">Final Letter</option>
                        <option value="FeeReestimate">Fee Re-estimate Letter</option>
                    </select>
                </div>
                
                <div id="dynamicFields">
                    <!-- Dynamic fields will be inserted here based on letter type -->
                </div>
                
                <!-- CDR Checkbox for Letter Generation -->
                <div class="cdr-checkbox" id="cdrForLetterSection" style="display: none;">
                    <div class="checkbox-item">
                        <input type="checkbox" id="generateCDRWithLetter" onchange="toggleCDRFields()">
                        <label for="generateCDRWithLetter">Generate CDR for next appearance?</label>
                    </div>
                    
                    <div id="cdrFieldsInLetter" style="display: none; margin-top: 15px;">
                        <h4>CDR Details (will auto-populate from letter data)</h4>
                        <div class="form-group">
                            <label for="nextCourtDate">Next Court Date:</label>
                            <input type="date" id="nextCourtDate">
                        </div>
                        <div class="form-group">
                            <label for="letterCDRReason">CDR Reason:</label>
                            <select id="letterCDRReason">
                                <option value="">-- Select Reason --</option>
                                <option value="Mention">Mention</option>
                                <option value="Mention (Brief Reply)">Mention (Brief Reply)</option>
                                <option value="Sentence">Sentence</option>
                                <option value="Hearing">Hearing</option>
                                <option value="Compliance Mention">Compliance Mention</option>
                                <option value="Brief Status">Brief Status</option>
                                <option value="Charge Certification">Charge Certification</option>
                                <option value="Committal">Committal</option>
                                <option value="Arraignment">Arraignment</option>
                                <option value="Return of Subpoena">Return of Subpoena</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Allocate To:</label>
                            <div class="checkbox-group">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="letter_allocate_AAG" value="AAG">
                                    <label for="letter_allocate_AAG">AAG</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="letter_allocate_RHH" value="RHH">
                                    <label for="letter_allocate_RHH">RHH</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="letter_allocate_SRS" value="SRS">
                                    <label for="letter_allocate_SRS">SRS</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="letter_allocate_BJB" value="BJB">
                                    <label for="letter_allocate_BJB">BJB</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="letter_allocate_NKM" value="NKM">
                                    <label for="letter_allocate_NKM">NKM</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="checkbox-item">
                            <input type="checkbox" id="letterCDRClientExcused">
                            <label for="letterCDRClientExcused">Client Excused</label>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 30px;">
                    <button class="btn btn-primary" onclick="generatePrompt()">Generate Claude Prompt</button>
                    <button class="btn btn-success" onclick="copyPrompt()">Copy to Clipboard</button>
                    <button class="btn btn-secondary" onclick="clearForm()">Clear Form</button>
                    <button class="btn btn-success" onclick="sendToZapier()">Send to Zapier</button>
                    <button class="btn btn-primary" onclick="updateExcelRecord()">Update Excel Record</button>
                </div>
                
                <div id="promptOutput" class="output-box" style="display: none;">
                    <!-- Generated prompt appears here -->
                </div>
                
                <div id="zapierStatus" style="display: none; margin-top: 10px; padding: 10px; border-radius: 4px;"></div>
            </div>
        </div>
        
        <!-- CDR Tab -->
        <div id="cdr" class="tab-content">
            <h2>Court Diary Request (CDR)</h2>
            <p>Generate CDR for court appearances</p>
            
            <div class="form-group">
                <label for="cdrClientSelect">Select Client (Optional):</label>
                <select id="cdrClientSelect" onchange="loadCDRClientInfo()">
                    <option value="">-- Manual Entry --</option>
                </select>
            </div>
            
            <div class="section">
                <div class="section-title">Court Outcome</div>
                
                <div class="form-group">
                    <label for="cdrOutcomeCourt">Court:</label>
                    <input type="text" id="cdrOutcomeCourt" placeholder="Enter court name">
                </div>
                
                <div class="form-group">
                    <label for="cdrOutcomeDate">Date:</label>
                    <input type="date" id="cdrOutcomeDate">
                </div>
                
                <div class="form-group">
                    <label for="cdrStartTime">Start Time:</label>
                    <input type="time" id="cdrStartTime" value="09:30">
                </div>
                
                <div class="form-group">
                    <label for="cdrFinishTime">Finish Time:</label>
                    <input type="time" id="cdrFinishTime" value="10:00">
                </div>
            </div>
            
            <div class="section">
                <div class="section-title">Court Diary Request</div>
                
                <div class="form-group">
                    <label for="cdrCourtDate">Court Date:</label>
                    <input type="date" id="cdrCourtDate">
                </div>
                
                <div class="form-group">
                    <label for="cdrSolicitor">Solicitor:</label>
                    <select id="cdrSolicitor">
                        <option value="AAG" selected>AAG</option>
                        <option value="RHH">RHH</option>
                        <option value="SRS">SRS</option>
                        <option value="BJB">BJB</option>
                        <option value="NKM">NKM</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="cdrClientName">Client Name:</label>
                    <input type="text" id="cdrClientName" placeholder="Enter client name">
                </div>
                
                <div class="form-group">
                    <label for="cdrFileNumber">File Number:</label>
                    <input type="text" id="cdrFileNumber" placeholder="Enter file number">
                </div>
                
                <div class="form-group">
                    <label for="cdrReason">Reason:</label>
                    <select id="cdrReason">
                        <option value="">-- Select Reason --</option>
                        <option value="Mention">Mention</option>
                        <option value="Mention (Brief Reply)">Mention (Brief Reply)</option>
                        <option value="Sentence">Sentence</option>
                        <option value="Hearing">Hearing</option>
                        <option value="Compliance Mention">Compliance Mention</option>
                        <option value="Brief Status">Brief Status</option>
                        <option value="Charge Certification">Charge Certification</option>
                        <option value="Committal">Committal</option>
                        <option value="Arraignment">Arraignment</option>
                        <option value="Return of Subpoena">Return of Subpoena</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="cdrCourt">Court:</label>
                    <input type="text" id="cdrCourt" placeholder="Enter court name">
                </div>
                
                <div class="form-group">
                    <label for="cdrCourtTime">Court Time:</label>
                    <input type="time" id="cdrCourtTime" value="09:30">
                </div>
                
                <div class="form-group">
                    <label>Allocate To:</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="allocate_AAG" value="AAG">
                            <label for="allocate_AAG">AAG</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="allocate_RHH" value="RHH">
                            <label for="allocate_RHH">RHH</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="allocate_SRS" value="SRS">
                            <label for="allocate_SRS">SRS</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="allocate_BJB" value="BJB">
                            <label for="allocate_BJB">BJB</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="allocate_NKM" value="NKM">
                            <label for="allocate_NKM">NKM</label>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="cdrClientExcused">
                        <label for="cdrClientExcused">Client Excused</label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="cdrFeeReminder">Fee Reminder:</label>
                    <input type="text" id="cdrFeeReminder" placeholder="Enter fee reminder details">
                </div>
            </div>
            
            <div style="margin-top: 30px;">
                <button class="btn btn-primary" onclick="generateCDR()">Generate CDR</button>
                <button class="btn btn-success" onclick="sendCDRToZapier()">Send CDR to Zapier</button>
                <button class="btn btn-secondary" onclick="clearCDRForm()">Clear Form</button>
            </div>
            
            <div id="cdrOutput" class="output-box" style="display: none;">
                <!-- Generated CDR appears here -->
            </div>
            
            <div id="cdrZapierStatus" style="display: none; margin-top: 10px; padding: 10px; border-radius: 4px;"></div>
        </div>
        
        <!-- Analytics Tab -->
        <div id="analytics" class="tab-content">
            <h2>Matter Analytics</h2>
            <p>Overview of your client matters and letter status</p>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                <div style="background: #f0f9ff; padding: 20px; border-radius: 8px; text-align: center;">
                    <h3 style="margin: 0; color: #0284c7;">Total Matters</h3>
                    <p style="font-size: 2em; font-weight: bold; margin: 10px 0; color: #0284c7;" id="totalMatters">0</p>
                </div>
                <div style="background: #f0fdf4; padding: 20px; border-radius: 8px; text-align: center;">
                    <h3 style="margin: 0; color: #16a34a;">Active Cases</h3>
                    <p style="font-size: 2em; font-weight: bold; margin: 10px 0; color: #16a34a;" id="activeMatters">0</p>
                </div>
                <div style="background: #fefce8; padding: 20px; border-radius: 8px; text-align: center;">
                    <h3 style="margin: 0; color: #ca8a04;">Pending Letters</h3>
                    <p style="font-size: 2em; font-weight: bold; margin: 10px 0; color: #ca8a04;" id="pendingLetters">0</p>
                </div>
                <div style="background: #fdf2f8; padding: 20px; border-radius: 8px; text-align: center;">
                    <h3 style="margin: 0; color: #be185d;">Next Week</h3>
                    <p style="font-size: 2em; font-weight: bold; margin: 10px 0; color: #be185d;" id="upcomingCourt">0</p>
                </div>
            </div>
            
            <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3>Matters by Court</h3>
                <div id="courtBreakdown"></div>
            </div>
            
            <div style="background: white; padding: 20px; border-radius: 8px;">
                <h3>Letter Status Overview</h3>
                <div id="letterStatusChart"></div>
            </div>
        </div>
    </div>
    
    <!-- Add Client Modal -->
    <div id="addClientModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>Add New Client</h2>
            
            <form id="addClientForm" onsubmit="addClient(event)">
                <div class="form-group">
                    <label for="newClientName">Client Name:</label>
                    <input type="text" id="newClientName" required>
                </div>
                
                <div class="form-group">
                    <label for="newClientAddress">Address:</label>
                    <textarea id="newClientAddress" required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="newMatterNumber">Matter Reference:</label>
                    <input type="text" id="newMatterNumber" required>
                </div>
                
                <div class="form-group">
                    <label for="newCourt">Court:</label>
                    <select id="newCourt" required>
                        <option value="">-- Select Court --</option>
                        <option value="Balmain Local Court">Balmain Local Court</option>
                        <option value="Bankstown Local Court">Bankstown Local Court</option>
                        <option value="Blacktown Local Court">Blacktown Local Court</option>
                        <option value="Burwood Local Court">Burwood Local Court</option>
                        <option value="Campbelltown District Court">Campbelltown District Court</option>
                        <option value="Campbelltown Local Court">Campbelltown Local Court</option>
                        <option value="Downing Centre District Court">Downing Centre District Court</option>
                        <option value="Downing Centre Local Court">Downing Centre Local Court</option>
                        <option value="Fairfield Local Court">Fairfield Local Court</option>
                        <option value="Hornsby Local Court">Hornsby Local Court</option>
                        <option value="Liverpool Local Court">Liverpool Local Court</option>
                        <option value="Manly Local Court">Manly Local Court</option>
                        <option value="Newtown Local Court">Newtown Local Court</option>
                        <option value="Parramatta District Court">Parramatta District Court</option>
                        <option value="Parramatta Local Court">Parramatta Local Court</option>
                        <option value="Penrith District Court">Penrith District Court</option>
                        <option value="Penrith Local Court">Penrith Local Court</option>
                        <option value="Sutherland Local Court">Sutherland Local Court</option>
                        <option value="Sydney District Court">Sydney District Court</option>
                        <option value="Waverley Local Court">Waverley Local Court</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="newMatterType">Matter Type:</label>
                    <select id="newMatterType" required>
                        <option value="">-- Select Matter Type --</option>
                        <option value="Criminal - Summary">Criminal - Summary</option>
                        <option value="Criminal - Indictable">Criminal - Indictable</option>
                        <option value="ADVO">ADVO</option>
                        <option value="Bail Application">Bail Application</option>
                        <option value="Appeal">Appeal</option>
                        <option value="Section 14 Application">Section 14 Application</option>
                        <option value="Trial">Trial</option>
                        <option value="Sentence">Sentence</option>
                        <option value="Committal">Committal</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="newCharges">Charges:</label>
                    <input type="text" id="newCharges" placeholder="e.g., Common Assault - s61 Crimes Act" required>
                </div>
                
                <div class="form-group">
                    <label for="newLegalAid">Legal Aid?</label>
                    <select id="newLegalAid">
                        <option value="No">No</option>
                        <option value="Yes">Yes</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="newNextCourt">Next Court Date:</label>
                    <input type="date" id="newNextCourt">
                </div>
                
                <button type="submit" class="btn btn-primary">Add Client</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            </form>
        </div>
    </div>
    
    <button class="add-client-btn" onclick="openModal()" title="Add New Client">+</button>
</body>
</html>
