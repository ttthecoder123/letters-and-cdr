<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Legal Letter Generation System</title>
    <!-- Include SheetJS library for Excel handling -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script>
        // Define all global functions BEFORE the HTML loads
        
        // Global variables
        var clients = [];
        var currentClient = null;
        var currentCDRData = null;
        
        // Switch between tabs
        function switchTab(tabName, event) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            var tabElement = document.getElementById(tabName);
            if (tabElement) {
                tabElement.classList.add('active');
            }
            if (event && event.target) {
                event.target.classList.add('active');
            }
            
            if (tabName === 'analytics' && typeof updateAnalytics === 'function') {
                updateAnalytics();
            }
        }
        
        // Define other critical functions that are called from HTML
        function openModal() {
            document.getElementById('addClientModal').style.display = 'block';
        }
        
        function closeModal() {
            document.getElementById('addClientModal').style.display = 'none';
            document.getElementById('addClientForm').reset();
        }
        
        // Load CDR client info
        function loadCDRClientInfo() {
            const clientId = parseInt(document.getElementById('cdrClientSelect').value);
            
            if (!clientId) {
                // Clear fields for manual entry
                document.getElementById('cdrClientName').value = '';
                document.getElementById('cdrFileNumber').value = '';
                document.getElementById('cdrCourt').value = '';
                document.getElementById('cdrOutcomeCourt').value = '';
                return;
            }
            
            const client = clients.find(c => c.id === clientId);
            if (!client) return;
            
            // Populate CDR fields
            document.getElementById('cdrClientName').value = client.name;
            document.getElementById('cdrFileNumber').value = client.matterNumber;
            document.getElementById('cdrCourt').value = client.court;
            document.getElementById('cdrOutcomeCourt').value = client.court;
            
            // If client has next court date, populate that too
            if (client.nextCourt) {
                document.getElementById('cdrCourtDate').value = client.nextCourt;
            }
        }
        
        // Generate CDR
        function generateCDR() {
            const cdrData = {
                outcomeCourt: document.getElementById('cdrOutcomeCourt').value,
                outcomeDate: document.getElementById('cdrOutcomeDate').value,
                startTime: document.getElementById('cdrStartTime').value,
                finishTime: document.getElementById('cdrFinishTime').value,
                courtDate: document.getElementById('cdrCourtDate').value,
                solicitor: document.getElementById('cdrSolicitor').value,
                clientName: document.getElementById('cdrClientName').value,
                fileNumber: document.getElementById('cdrFileNumber').value,
                reason: document.getElementById('cdrReason').value,
                court: document.getElementById('cdrCourt').value,
                courtTime: document.getElementById('cdrCourtTime').value,
                allocateTo: getAllocatedTo(),
                clientExcused: document.getElementById('cdrClientExcused').checked,
                feeReminder: document.getElementById('cdrFeeReminder').value
            };
            
            currentCDRData = cdrData;
            
            let cdrText = formatCDRText(cdrData);
            
            const outputDiv = document.getElementById('cdrOutput');
            outputDiv.textContent = cdrText;
            outputDiv.style.display = 'block';
        }
        
        // Format CDR text
        function formatCDRText(cdrData) {
            let text = "** ** ** ** **COURT OUTCOME** ** ** **\n";
            text += `COURT: ${cdrData.outcomeCourt}\n`;
            text += `DATE: ${formatDate(cdrData.outcomeDate)}\n`;
            text += `CORAM: \n`;
            text += `CROWN: \n`;
            text += `START: ${cdrData.startTime}\n`;
            text += `FINISH: ${cdrData.finishTime}\n\n`;
            
            text += "**COURT DIARY REQUEST**\n";
            text += `COURT DATE: ${formatDate(cdrData.courtDate)}\n`;
            text += `SOLICITOR: ${cdrData.solicitor}\n`;
            text += `CLIENT: ${cdrData.clientName}\n`;
            text += `FILE NUMBER: ${cdrData.fileNumber}\n`;
            text += `REASON: ${cdrData.reason}\n`;
            text += `COURT: ${cdrData.court}\n`;
            text += `COURT TIME: ${cdrData.courtTime}\n`;
            text += `ALLOCATE TO: ${cdrData.allocateTo}\n`;
            text += `CLIENT EXCUSED: ${cdrData.clientExcused ? 'Yes' : 'No'}\n`;
            text += `FEE REMINDER: ${cdrData.feeReminder || 'N/A'}`;
            
            return text;
        }
        
        // Get allocated to checkboxes
        function getAllocatedTo() {
            const allocated = [];
            document.querySelectorAll('input[id^="allocate_"]:checked').forEach(cb => {
                allocated.push(cb.value);
            });
            return allocated.join(', ') || 'TBD';
        }
        
        // Send CDR to Zapier
        function sendCDRToZapier() {
            if (!currentCDRData) {
                alert('Please generate a CDR first');
                return;
            }
            
            const statusDiv = document.getElementById('cdrZapierStatus');
            statusDiv.style.display = 'block';
            statusDiv.style.backgroundColor = '#fef3c7';
            statusDiv.style.color = '#92400e';
            statusDiv.textContent = 'Sending CDR to Zapier...';
            
            // Prepare payload with CDR data only
            const payload = {
                // Type to identify this as CDR only
                type: 'CDR_ONLY',
                
                // Letter data - null for standalone CDR
                letterData: null,
                
                // CDR data - always present for standalone CDR
                cdrData: {
                    outcomeCourt: currentCDRData.outcomeCourt,
                    outcomeDate: currentCDRData.outcomeDate,
                    startTime: currentCDRData.startTime,
                    finishTime: currentCDRData.finishTime,
                    courtDate: currentCDRData.courtDate,
                    solicitor: currentCDRData.solicitor,
                    clientName: currentCDRData.clientName,
                    fileNumber: currentCDRData.fileNumber,
                    reason: currentCDRData.reason,
                    court: currentCDRData.court,
                    courtTime: currentCDRData.courtTime,
                    allocateTo: currentCDRData.allocateTo,
                    clientExcused: currentCDRData.clientExcused,
                    feeReminder: currentCDRData.feeReminder,
                    cdrText: formatCDRText(currentCDRData)
                },
                
                // Flags for Zapier to easily identify what's included
                hasLetter: false,
                hasCDR: true
            };
            
            const formData = new FormData();
            formData.append('data', JSON.stringify(payload));
            
            fetch('https://hooks.zapier.com/hooks/catch/19713185/u47iaxq/', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    statusDiv.style.backgroundColor = '#d4edda';
                    statusDiv.style.color = '#155724';
                    statusDiv.textContent = '✓ CDR successfully sent to Zapier!';
                    setTimeout(() => {
                        statusDiv.style.display = 'none';
                    }, 3000);
                } else {
                    throw new Error('Failed to send');
                }
            })
            .catch(error => {
                statusDiv.style.backgroundColor = '#f8d7da';
                statusDiv.style.color = '#721c24';
                statusDiv.textContent = '✗ Failed to send CDR to Zapier. Please try again.';
                console.error('Zapier error:', error);
            });
        }
        
        // Clear CDR form
        function clearCDRForm() {
            if (confirm('Clear all CDR fields?')) {
                document.getElementById('cdrClientSelect').value = '';
                document.getElementById('cdrOutcomeCourt').value = '';
                document.getElementById('cdrOutcomeDate').value = '';
                document.getElementById('cdrStartTime').value = '09:30';
                document.getElementById('cdrFinishTime').value = '10:00';
                document.getElementById('cdrCourtDate').value = '';
                document.getElementById('cdrSolicitor').value = 'AAG';
                document.getElementById('cdrClientName').value = '';
                document.getElementById('cdrFileNumber').value = '';
                document.getElementById('cdrReason').value = '';
                document.getElementById('cdrCourt').value = '';
                document.getElementById('cdrCourtTime').value = '09:30';
                document.getElementById('cdrClientExcused').checked = false;
                document.getElementById('cdrFeeReminder').value = '';
                
                // Clear all allocate checkboxes
                document.querySelectorAll('input[id^="allocate_"]').forEach(cb => cb.checked = false);
                
                document.getElementById('cdrOutput').style.display = 'none';
                currentCDRData = null;
            }
        }
        
        // Load client info for letter generation
        function loadClientInfo() {
            const clientId = parseInt(document.getElementById('clientSelect').value);
            const clientInfoSection = document.getElementById('clientInfoSection');
            
            if (!clientId) {
                clientInfoSection.style.display = 'none';
                return;
            }
            
            currentClient = clients.find(c => c.id === clientId);
            if (!currentClient) return;
            
            clientInfoSection.style.display = 'block';
            
            // Populate client info grid
            document.getElementById('clientInfoGrid').innerHTML = `
                <div class="info-item">
                    <div class="info-label">Client Name</div>
                    <div class="info-value">${currentClient.name}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Address</div>
                    <div class="info-value">${currentClient.address || 'Not provided'}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Matter Number</div>
                    <div class="info-value">${currentClient.matterNumber}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Court</div>
                    <div class="info-value">${currentClient.court}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Matter Type</div>
                    <div class="info-value">${currentClient.matterType}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Charges</div>
                    <div class="info-value">${currentClient.charges}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Legal Aid</div>
                    <div class="info-value">${currentClient.legalAid ? 'Yes' : 'No'}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Next Court</div>
                    <div class="info-value">${currentClient.nextCourt ? formatDate(currentClient.nextCourt) : 'TBD'}</div>
                </div>
            `;
            
            // Populate letter history
            const historyList = document.getElementById('letterHistoryList');
            if (currentClient.letterHistory && currentClient.letterHistory.length > 0) {
                historyList.innerHTML = currentClient.letterHistory.map(letter => `
                    <div class="letter-item">
                        <div>
                            <strong>${letter.type}</strong> - ${formatDate(letter.date)}
                            <br><small>${letter.notes || ''}</small>
                        </div>
                        <span class="status-badge status-completed">Sent</span>
                    </div>
                `).join('');
            } else {
                historyList.innerHTML = '<p style="color: #6b7280; font-style: italic;">No letters sent yet</p>';
            }
        }
        
        // Update letter fields
        function updateLetterFields() {
            const letterType = document.getElementById('letterType').value;
            const dynamicFields = document.getElementById('dynamicFields');
            const cdrSection = document.getElementById('cdrForLetterSection');
            
            if (!letterType || !currentClient) {
                dynamicFields.innerHTML = '';
                cdrSection.style.display = 'none';
                return;
            }
            
            // Show CDR section for all letter types
            cdrSection.style.display = 'block';
            
            let fieldsHTML = '';
            
            switch(letterType) {
                case 'CCL':
                    fieldsHTML = getCCLFields();
                    break;
                case 'Mention':
                    fieldsHTML = getMentionFields();
                    break;
                case 'Final':
                    fieldsHTML = getFinalFields();
                    break;
                case 'FeeReestimate':
                    fieldsHTML = getFeeReestimateFields();
                    break;
            }
            
            dynamicFields.innerHTML = fieldsHTML;
            
            // Initialize any conditional logic
            if (letterType === 'CCL') {
                toggleLegalAidFields();
                togglePleaOptions();
            }
        }
        
        // Toggle CDR fields in letter generation
        function toggleCDRFields() {
            const isChecked = document.getElementById('generateCDRWithLetter').checked;
            document.getElementById('cdrFieldsInLetter').style.display = isChecked ? 'block' : 'none';
        }
        
        // Generate prompt
        function generatePrompt() {
            const letterType = document.getElementById('letterType').value;
            
            if (!letterType || !currentClient) {
                alert('Please select a client and letter type');
                return;
            }
            
            let prompt = '';
            let cdrData = null;
            
            // Check if CDR should be generated
            const generateCDR = document.getElementById('generateCDRWithLetter')?.checked;
            if (generateCDR) {
                const nextCourtDate = document.getElementById('nextCourtDate')?.value;
                if (nextCourtDate) {
                    cdrData = {
                        outcomeCourt: currentClient.court,
                        outcomeDate: getTodayDate(),
                        startTime: '09:30',
                        finishTime: '10:00',
                        courtDate: nextCourtDate,
                        solicitor: 'AAG',
                        clientName: currentClient.name,
                        fileNumber: currentClient.matterNumber,
                        reason: document.getElementById('letterCDRReason')?.value || 'Mention',
                        court: currentClient.court,
                        courtTime: '09:30',
                        allocateTo: getLetterAllocatedTo(),
                        clientExcused: document.getElementById('letterCDRClientExcused')?.checked || false,
                        feeReminder: ''
                    };
                }
            }
            
            switch(letterType) {
                case 'CCL':
                    prompt = generateCCLPrompt();
                    break;
                case 'Mention':
                    prompt = generateMentionPrompt();
                    break;
                case 'Final':
                    prompt = generateFinalPrompt();
                    break;
                case 'FeeReestimate':
                    prompt = generateFeeReestimatePrompt();
                    break;
            }
            
            // Add CDR to prompt if generated
            if (cdrData) {
                prompt += '\n\n--- CDR ALSO GENERATED ---\n';
                prompt += formatCDRText(cdrData);
                currentCDRData = cdrData;
            }
            
            const outputDiv = document.getElementById('promptOutput');
            outputDiv.textContent = prompt;
            outputDiv.style.display = 'block';
            
            // Update letter history
            if (!currentClient.letterHistory) currentClient.letterHistory = [];
            currentClient.letterHistory.push({
                type: letterType,
                date: new Date().toISOString().slice(0,10),
                notes: `Generated ${letterType} prompt${cdrData ? ' with CDR' : ''}`
            });
            
            // Update letter sent status
            switch(letterType) {
                case 'CCL':
                    currentClient.ccl = true;
                    break;
                case 'Mention':
                    currentClient.mention = true;
                    break;
                case 'Final':
                    currentClient.final = true;
                    break;
            }
            
            saveData();
            updateUI();
        }
        
        // Copy prompt
        function copyPrompt() {
            const promptText = document.getElementById('promptOutput').textContent;
            if (!promptText) {
                alert('Please generate a prompt first');
                return;
            }
            
            navigator.clipboard.writeText(promptText).then(() => {
                alert('Prompt copied to clipboard!');
            }).catch(err => {
                // Fallback
                const textArea = document.createElement('textarea');
                textArea.value = promptText;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('Prompt copied to clipboard!');
            });
        }
        
        // Clear form
        function clearForm() {
            if (confirm('Clear all fields?')) {
                document.getElementById('letterType').value = '';
                document.getElementById('dynamicFields').innerHTML = '';
                document.getElementById('promptOutput').style.display = 'none';
            }
        }
        
        // Send to Zapier
        function sendToZapier() {
            const promptText = document.getElementById('promptOutput').textContent;
            const letterType = document.getElementById('letterType').value;
            
            if (!promptText || !currentClient || !letterType) {
                alert('Please generate a prompt first');
                return;
            }
            
            const statusDiv = document.getElementById('zapierStatus');
            statusDiv.style.display = 'block';
            statusDiv.style.backgroundColor = '#fef3c7';
            statusDiv.style.color = '#92400e';
            statusDiv.textContent = 'Sending to Zapier...';
            
            // Check if CDR is included
            const hasCDR = document.getElementById('generateCDRWithLetter')?.checked;
            
            // Prepare payload with separate letter and CDR data
            const payload = {
                // Type to identify what's being sent
                type: hasCDR ? 'LETTER_AND_CDR' : letterType,
                
                // Letter data - always present when sending from letter generator
                letterData: {
                    letterType: letterType,
                    prompt: promptText,
                    clientName: currentClient.name,
                    matterNumber: currentClient.matterNumber,
                    court: currentClient.court,
                    templateFileName: getTemplateFileName(letterType)
                },
                
                // CDR data - only present if CDR checkbox is checked
                cdrData: null,
                
                // Flags for Zapier to easily identify what's included
                hasLetter: true,
                hasCDR: hasCDR
            };
            
            // Add CDR data if generated
            if (hasCDR && currentCDRData) {
                payload.cdrData = {
                    outcomeCourt: currentCDRData.outcomeCourt,
                    outcomeDate: currentCDRData.outcomeDate,
                    startTime: currentCDRData.startTime,
                    finishTime: currentCDRData.finishTime,
                    courtDate: currentCDRData.courtDate,
                    solicitor: currentCDRData.solicitor,
                    clientName: currentCDRData.clientName,
                    fileNumber: currentCDRData.fileNumber,
                    reason: currentCDRData.reason,
                    court: currentCDRData.court,
                    courtTime: currentCDRData.courtTime,
                    allocateTo: currentCDRData.allocateTo,
                    clientExcused: currentCDRData.clientExcused,
                    feeReminder: currentCDRData.feeReminder,
                    cdrText: formatCDRText(currentCDRData)
                };
            }
            
            // Create form data
            const formData = new FormData();
            formData.append('data', JSON.stringify(payload));
            
            fetch('https://hooks.zapier.com/hooks/catch/19713185/u47iaxq/', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (response.ok) {
                    statusDiv.style.backgroundColor = '#d4edda';
                    statusDiv.style.color = '#155724';
                    statusDiv.textContent = hasCDR ? 
                        '✓ Successfully sent letter and CDR to Zapier!' : 
                        '✓ Successfully sent to Zapier!';
                    setTimeout(() => {
                        statusDiv.style.display = 'none';
                    }, 3000);
                } else {
                    throw new Error('Failed to send');
                }
            })
            .catch(error => {
                statusDiv.style.backgroundColor = '#f8d7da';
                statusDiv.style.color = '#721c24';
                statusDiv.textContent = '✗ Failed to send to Zapier. Please try again.';
                console.error('Zapier error:', error);
            });
        }
        
        // Update Excel record
        function updateExcelRecord() {
            const letterType = document.getElementById('letterType').value;
            
            if (!currentClient || !letterType) {
                alert('Please select a client and generate a letter first');
                return;
            }
            
            // Update the client record
            const clientIndex = clients.findIndex(c => c.id === currentClient.id);
            if (clientIndex !== -1) {
                // Update letter sent status
                switch(letterType) {
                    case 'CCL':
                        clients[clientIndex].ccl = true;
                        break;
                    case 'Mention':
                        clients[clientIndex].mention = true;
                        break;
                    case 'Final':
                        clients[clientIndex].final = true;
                        break;
                }
                
                // Update last updated date
                clients[clientIndex].lastUpdated = new Date().toLocaleDateString('en-AU');
                
                // Save to localStorage
                saveData();
                
                // Update UI
                updateUI();
                
                // Export to Excel automatically
                exportToExcel();
                
                alert(`Excel database updated!\n${letterType} marked as sent for ${currentClient.name}`);
            }
        }
        
        // Add client
        function addClient(event) {
            event.preventDefault();
            
            const newClient = {
                id: clients.length > 0 ? Math.max(...clients.map(c => c.id)) + 1 : 1,
                name: document.getElementById('newClientName').value,
                address: document.getElementById('newClientAddress').value,
                matterNumber: document.getElementById('newMatterNumber').value,
                court: document.getElementById('newCourt').value,
                matterType: document.getElementById('newMatterType').value,
                charges: document.getElementById('newCharges').value,
                legalAid: document.getElementById('newLegalAid').value === 'Yes',
                nextCourt: document.getElementById('newNextCourt').value,
                status: 'Active',
                ccl: false,
                mention: false,
                final: false,
                letterHistory: []
            };
            
            clients.push(newClient);
            saveData();
            updateUI();
            closeModal();
            
            alert('Client added successfully!');
        }
        
        // Select client for letter from master list
        function selectClientForLetter(clientId) {
            // Find the generator tab button and trigger click
            const generatorTab = document.querySelector('.tab:nth-child(2)');
            if (generatorTab) {
                generatorTab.click();
            }
            document.getElementById('clientSelect').value = clientId;
            loadClientInfo();
        }
        
        // Helper function to get template file name
        function getTemplateFileName(letterType) {
            const templateMap = {
                'CCL': 'CCL_Template.docx',
                'Mention': 'Mention_Template.docx',
                'Final': 'Final_Template.docx',
                'FeeReestimate': 'FeeReestimate_Template.docx'
            };
            return templateMap[letterType] || 'Template.docx';
        }
        
        // Get letter allocated to
        function getLetterAllocatedTo() {
            const allocated = [];
            document.querySelectorAll('input[id^="letter_allocate_"]:checked').forEach(cb => {
                allocated.push(cb.value);
            });
            return allocated.join(', ') || 'TBD';
        }
        
        // Utility functions
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const options = { day: 'numeric', month: 'long', year: 'numeric' };
            return date.toLocaleDateString('en-AU', options);
        }
        
        function getTodayDate() {
            return new Date().toISOString().split('T')[0];
        }
        
        function loadExcelFile() {
            const fileInput = document.getElementById('excelFile');
            const file = fileInput.files[0];
            
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    // Convert Excel data to our format
                    clients = jsonData.map((row, index) => ({
                        id: index + 1,
                        name: row['Client Name'] || '',
                        address: row['Address'] || '',
                        matterNumber: row['Matter Reference'] || '',
                        court: row['Court'] || '',
                        matterType: row['Matter Type'] || '',
                        charges: row['Charges'] || '',
                        legalAid: row['Legal Aid'] === 'Yes',
                        contribution: row['Contribution'] || '',
                        status: row['Status'] || 'Active',
                        ccl: row['CCL Sent'] === 'Yes' || false,
                        mention: row['Mention Sent'] === 'Yes' || false,
                        final: row['Final Sent'] === 'Yes' || false,
                        nextCourt: row['Next Court Date'] || '',
                        letterHistory: []
                    }));
                    
                    saveData();
                    updateUI();
                    updateDatabaseStatus(true);
                    alert(`Successfully loaded ${clients.length} clients from Excel`);
                } catch (error) {
                    alert('Error loading Excel file: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        function exportToExcel() {
            if (clients.length === 0) {
                alert('No data to export');
                return;
            }
            
            // Prepare data for export
            const exportData = clients.map(client => ({
                'Client Name': client.name,
                'Address': client.address,
                'Matter Reference': client.matterNumber,
                'Court': client.court,
                'Matter Type': client.matterType,
                'Charges': client.charges,
                'Legal Aid': client.legalAid ? 'Yes' : 'No',
                'Contribution': client.contribution || '',
                'Status': client.status,
                'CCL Sent': client.ccl ? 'Yes' : 'No',
                'Mention Sent': client.mention ? 'Yes' : 'No',
                'Final Sent': client.final ? 'Yes' : 'No',
                'Next Court Date': client.nextCourt,
                'Last Updated': new Date().toLocaleDateString('en-AU')
            }));
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(exportData);
            XLSX.utils.book_append_sheet(wb, ws, 'Clients');
            XLSX.writeFile(wb, `legal_clients_${new Date().toISOString().slice(0,10)}.xlsx`);
        }
    </script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f8fafc;
            color: #1e293b;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 20px;
            background: white;
            border-radius: 8px;
            padding: 4px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            color: #64748b;
        }
        
        .tab.active {
            background: #3b82f6;
            color: white;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
        }
        
        .tab:hover:not(.active) {
            background: #e2e8f0;
            color: #475569;
        }
        
        .tab-content {
            display: none;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .tab-content.active {
            display: block;
        }
        
        .master-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .master-table th {
            background: #f1f5f9;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #475569;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .master-table td {
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .master-table tr:hover {
            background: #f8fafc;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .status-active { background: #dcfce7; color: #166534; }
        .status-waiting { background: #fef3c7; color: #92400e; }
        .status-completed { background: #dbeafe; color: #1e40af; }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }
        
        .form-group select,
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        
        .form-group select:focus,
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 12px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            transition: all 0.2s;
        }
        
        .checkbox-item:hover {
            border-color: #3b82f6;
            background: #f8fafc;
        }
        
        .checkbox-item input[type="checkbox"],
        .checkbox-item input[type="radio"] {
            width: auto;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            margin-right: 10px;
        }
        
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .output-box {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .client-info {
            background: #f0f9ff;
            border: 2px solid #0284c7;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }
        
        .client-info h3 {
            margin: 0 0 12px 0;
            color: #0284c7;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }
        
        .info-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .info-label {
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .info-value {
            font-weight: 500;
            color: #1f2937;
        }
        
        .section {
            border-top: 2px solid #eee;
            margin-top: 25px;
            padding-top: 20px;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 15px;
        }
        
        .charges-section {
            background: #f9fafb;
            border-radius: 8px;
            padding: 16px;
            margin-top: 12px;
        }
        
        .charges-category {
            margin-bottom: 20px;
        }
        
        .charges-category h4 {
            color: #374151;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .multi-select {
            min-height: 120px;
        }
        
        .conditional {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background-color: #f0f8ff;
            border-radius: 8px;
            border: 1px solid #e0e7ff;
        }
        
        .database-status {
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 4px;
            text-align: center;
            font-weight: bold;
        }
        
        .status-connected {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-disconnected {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .letter-history {
            background: #f9fafb;
            border-radius: 8px;
            padding: 16px;
            margin-top: 20px;
        }
        
        .letter-history h4 {
            margin: 0 0 12px 0;
            color: #374151;
        }
        
        .letter-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .letter-item:last-child {
            border-bottom: none;
        }
        
        .add-client-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #3b82f6;
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
            transition: all 0.2s;
        }
        
        .add-client-btn:hover {
            background: #2563eb;
            transform: scale(1.1);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 12px;
            padding: 30px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #6b7280;
        }
        
        .close:hover {
            color: #374151;
        }
        
        .cdr-checkbox {
            background: #fef3c7;
            border: 2px solid #fbbf24;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }
        
        .cdr-checkbox label {
            font-weight: 600;
            color: #92400e;
        }
        
        @media (max-width: 768px) {
            .checkbox-group {
                grid-template-columns: 1fr;
            }
            
            .tabs {
                flex-wrap: wrap;
            }
        }
        
        /* Mobile-specific styles for iPhone */
        @media (max-width: 430px) {
            body {
                padding: 10px;
                font-size: 16px;
            }
            
            .container {
                padding: 0;
            }
            
            .header {
                padding: 20px;
                margin-bottom: 20px;
            }
            
            .header h1 {
                font-size: 24px;
            }
            
            .header p {
                font-size: 14px;
            }
            
            /* Tab navigation - make it a dropdown on mobile */
            .tabs {
                display: block;
                position: relative;
                background: transparent;
                padding: 0;
                box-shadow: none;
            }
            
            .tab {
                display: block;
                width: 100%;
                padding: 15px;
                margin-bottom: 2px;
                border-radius: 8px;
                font-size: 16px;
                text-align: left;
            }
            
            /* Larger form elements */
            .form-group input,
            .form-group select,
            .form-group textarea {
                font-size: 16px;
                padding: 15px;
                border-radius: 8px;
            }
            
            .form-group label {
                font-size: 16px;
                margin-bottom: 10px;
            }
            
            /* Checkboxes - make them larger and easier to tap */
            .checkbox-item {
                padding: 15px;
                margin-bottom: 8px;
                border-radius: 8px;
                font-size: 16px;
            }
            
            .checkbox-item input[type="checkbox"],
            .checkbox-item input[type="radio"] {
                width: 20px;
                height: 20px;
                margin-right: 12px;
            }
            
            /* Buttons - full width and larger */
            .btn {
                width: 100%;
                padding: 16px;
                font-size: 16px;
                margin-bottom: 10px;
                margin-right: 0;
            }
            
            .button-group {
                flex-direction: column;
                gap: 0;
            }
            
            /* Table adjustments */
            .master-table {
                font-size: 12px;
                display: block;
                overflow-x: auto;
            }
            
            .master-table th,
            .master-table td {
                padding: 8px 4px;
                font-size: 12px;
            }
            
            /* Hide some columns on mobile */
            .master-table th:nth-child(4),
            .master-table td:nth-child(4),
            .master-table th:nth-child(5),
            .master-table td:nth-child(5) {
                display: none;
            }
            
            /* Section spacing */
            .section {
                margin-top: 20px;
                padding-top: 20px;
            }
            
            .section-title {
                font-size: 20px;
                margin-bottom: 15px;
            }
            
            /* Output box */
            .output-box {
                font-size: 14px;
                padding: 15px;
                max-height: 300px;
            }
            
            /* Charges section - stack vertically */
            .charges-category {
                margin-bottom: 15px;
            }
            
            .charges-category h4 {
                font-size: 18px;
                margin-bottom: 12px;
            }
            
            /* Info grid - single column on mobile */
            .info-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            /* Modal adjustments */
            .modal-content {
                width: 95%;
                padding: 20px;
                margin: 20px auto;
            }
            
            /* Add client button - fixed position */
            .add-client-btn {
                bottom: 20px;
                right: 20px;
                width: 56px;
                height: 56px;
                font-size: 28px;
            }
            
            /* Multi-select - make taller */
            .multi-select {
                min-height: 150px;
                font-size: 16px;
            }
            
            /* Client info box */
            .client-info {
                padding: 15px;
                margin-bottom: 15px;
            }
            
            .client-info h3 {
                font-size: 18px;
            }
            
            /* Letter history */
            .letter-history {
                padding: 15px;
                margin-top: 15px;
            }
            
            /* Conditional sections */
            .conditional {
                margin-top: 10px;
                padding: 12px;
            }
            
            /* Analytics grid */
            #analytics .tab-content > div:first-child {
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }
            
            #analytics .tab-content > div:first-child > div {
                padding: 15px;
            }
            
            #analytics .tab-content > div:first-child h3 {
                font-size: 14px;
            }
            
            #analytics .tab-content > div:first-child p {
                font-size: 1.5em;
            }
            
            /* Database status */
            .database-status {
                font-size: 14px;
                padding: 12px;
                margin-bottom: 15px;
            }
            
            /* Remove hover effects on mobile */
            .checkbox-item:hover {
                border-color: #e5e7eb;
                background: transparent;
            }
            
            /* Tab content padding */
            .tab-content {
                padding: 20px;
                border-radius: 12px;
            }
            
            /* Sticky action buttons at bottom */
            #generator .btn-primary,
            #generator .btn-success {
                position: fixed;
                bottom: 20px;
                width: calc(50% - 25px);
                z-index: 100;
            }
            
            #generator .btn-primary {
                left: 20px;
            }
            
            #generator .btn-success {
                right: 20px;
            }
            
            #generator > div:last-child {
                padding-bottom: 80px;
            }
            
            /* Zapier status */
            #zapierStatus {
                position: fixed;
                bottom: 80px;
                left: 20px;
                right: 20px;
                z-index: 99;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Legal Letter Generation System</h1>
            <p>Streamlined client matter management and automated Claude prompt generation</p>
        </div>
        
        <div class="database-status" id="databaseStatus">
            Database: Not Connected
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('master', event)">Master Client List</button>
            <button class="tab" onclick="switchTab('generator', event)">Letter Generator</button>
            <button class="tab" onclick="switchTab('cdr', event)">CDR</button>
            <button class="tab" onclick="switchTab('analytics', event)">Analytics</button>
        </div>
        
        <!-- Master Client List Tab -->
        <div id="master" class="tab-content active">
            <h2>Active Client Matters</h2>
            <p>Manage your active matters and track letter status</p>
            
            <table class="master-table" id="clientTable">
                <thead>
                    <tr>
                        <th>Client Name</th>
                        <th>Matter #</th>
                        <th>Court</th>
                        <th>Charges</th>
                        <th>Status</th>
                        <th>CCL</th>
                        <th>Mention</th>
                        <th>Final</th>
                        <th>Next Court</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="clientTableBody">
                    <tr>
                        <td colspan="10" style="text-align: center; padding: 40px; color: #6b7280;">
                            No clients loaded. Please upload an Excel database or add clients manually.
                        </td>
                    </tr>
                </tbody>
            </table>
            
            <div style="margin-top: 20px;">
                <input type="file" id="excelFile" accept=".xlsx,.xls,.csv" onchange="loadExcelFile()" style="display: none;">
                <button class="btn btn-primary" onclick="document.getElementById('excelFile').click()">
                    Upload Excel Database
                </button>
                <button class="btn btn-secondary" onclick="exportToExcel()">
                    Export to Excel
                </button>
            </div>
        </div>
        
        <!-- Letter Generator Tab -->
        <div id="generator" class="tab-content">
            <h2>Generate Letter Prompt</h2>
            
            <div class="form-group">
                <label for="clientSelect">Select Client:</label>
                <select id="clientSelect" onchange="loadClientInfo()">
                    <option value="">-- Select a Client --</option>
                </select>
            </div>
            
            <div id="clientInfoSection" style="display: none;">
                <div class="client-info">
                    <h3>Client Information</h3>
                    <div class="info-grid" id="clientInfoGrid">
                        <!-- Auto-populated from selection -->
                    </div>
                </div>
                
                <div class="letter-history" id="letterHistorySection">
                    <h4>Letter History</h4>
                    <div id="letterHistoryList">
                        <!-- Auto-populated -->
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="letterType">Letter Type:</label>
                    <select id="letterType" onchange="updateLetterFields()">
                        <option value="">-- Select Letter Type --</option>
                        <option value="CCL">Client Care Letter (CCL)</option>
                        <option value="Mention">Mention Letter</option>
                        <option value="Final">Final Letter</option>
                        <option value="FeeReestimate">Fee Re-estimate Letter</option>
                    </select>
                </div>
                
                <div id="dynamicFields">
                    <!-- Dynamic fields will be inserted here based on letter type -->
                </div>
                
                <!-- CDR Checkbox for Letter Generation -->
                <div class="cdr-checkbox" id="cdrForLetterSection" style="display: none;">
                    <div class="checkbox-item">
                        <input type="checkbox" id="generateCDRWithLetter" onchange="toggleCDRFields()">
                        <label for="generateCDRWithLetter">Generate CDR for next appearance?</label>
                    </div>
                    
                    <div id="cdrFieldsInLetter" style="display: none; margin-top: 15px;">
                        <h4>CDR Details (will auto-populate from letter data)</h4>
                        <div class="form-group">
                            <label for="letterCDRReason">CDR Reason:</label>
                            <select id="letterCDRReason">
                                <option value="">-- Select Reason --</option>
                                <option value="Mention">Mention</option>
                                <option value="Mention (Brief Reply)">Mention (Brief Reply)</option>
                                <option value="Sentence">Sentence</option>
                                <option value="Hearing">Hearing</option>
                                <option value="Compliance Mention">Compliance Mention</option>
                                <option value="Brief Status">Brief Status</option>
                                <option value="Charge Certification">Charge Certification</option>
                                <option value="Committal">Committal</option>
                                <option value="Arraignment">Arraignment</option>
                                <option value="Return of Subpoena">Return of Subpoena</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Allocate To:</label>
                            <div class="checkbox-group">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="letter_allocate_AAG" value="AAG">
                                    <label for="letter_allocate_AAG">AAG</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="letter_allocate_RHH" value="RHH">
                                    <label for="letter_allocate_RHH">RHH</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="letter_allocate_SRS" value="SRS">
                                    <label for="letter_allocate_SRS">SRS</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="letter_allocate_BJB" value="BJB">
                                    <label for="letter_allocate_BJB">BJB</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="letter_allocate_NKM" value="NKM">
                                    <label for="letter_allocate_NKM">NKM</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="checkbox-item">
                            <input type="checkbox" id="letterCDRClientExcused">
                            <label for="letterCDRClientExcused">Client Excused</label>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 30px;">
                    <button class="btn btn-primary" onclick="generatePrompt()">Generate Claude Prompt</button>
                    <button class="btn btn-success" onclick="copyPrompt()">Copy to Clipboard</button>
                    <button class="btn btn-secondary" onclick="clearForm()">Clear Form</button>
                    <button class="btn btn-success" onclick="sendToZapier()">Send to Zapier</button>
                    <button class="btn btn-primary" onclick="updateExcelRecord()">Update Excel Record</button>
                </div>
                
                <div id="promptOutput" class="output-box" style="display: none;">
                    <!-- Generated prompt appears here -->
                </div>
                
                <div id="zapierStatus" style="display: none; margin-top: 10px; padding: 10px; border-radius: 4px;"></div>
            </div>
        </div>
        
        <!-- CDR Tab -->
        <div id="cdr" class="tab-content">
            <h2>Court Diary Request (CDR)</h2>
            <p>Generate CDR for court appearances</p>
            
            <div class="form-group">
                <label for="cdrClientSelect">Select Client (Optional):</label>
                <select id="cdrClientSelect" onchange="loadCDRClientInfo()">
                    <option value="">-- Manual Entry --</option>
                </select>
            </div>
            
            <div class="section">
                <div class="section-title">Court Outcome</div>
                
                <div class="form-group">
                    <label for="cdrOutcomeCourt">Court:</label>
                    <input type="text" id="cdrOutcomeCourt" placeholder="Enter court name">
                </div>
                
                <div class="form-group">
                    <label for="cdrOutcomeDate">Date:</label>
                    <input type="date" id="cdrOutcomeDate">
                </div>
                
                <div class="form-group">
                    <label for="cdrStartTime">Start Time:</label>
                    <input type="time" id="cdrStartTime" value="09:30">
                </div>
                
                <div class="form-group">
                    <label for="cdrFinishTime">Finish Time:</label>
                    <input type="time" id="cdrFinishTime" value="10:00">
                </div>
            </div>
            
            <div class="section">
                <div class="section-title">Court Diary Request</div>
                
                <div class="form-group">
                    <label for="cdrCourtDate">Court Date:</label>
                    <input type="date" id="cdrCourtDate">
                </div>
                
                <div class="form-group">
                    <label for="cdrSolicitor">Solicitor:</label>
                    <select id="cdrSolicitor">
                        <option value="AAG" selected>AAG</option>
                        <option value="RHH">RHH</option>
                        <option value="SRS">SRS</option>
                        <option value="BJB">BJB</option>
                        <option value="NKM">NKM</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="cdrClientName">Client Name:</label>
                    <input type="text" id="cdrClientName" placeholder="Enter client name">
                </div>
                
                <div class="form-group">
                    <label for="cdrFileNumber">File Number:</label>
                    <input type="text" id="cdrFileNumber" placeholder="Enter file number">
                </div>
                
                <div class="form-group">
                    <label for="cdrReason">Reason:</label>
                    <select id="cdrReason">
                        <option value="">-- Select Reason --</option>
                        <option value="Mention">Mention</option>
                        <option value="Mention (Brief Reply)">Mention (Brief Reply)</option>
                        <option value="Sentence">Sentence</option>
                        <option value="Hearing">Hearing</option>
                        <option value="Compliance Mention">Compliance Mention</option>
                        <option value="Brief Status">Brief Status</option>
                        <option value="Charge Certification">Charge Certification</option>
                        <option value="Committal">Committal</option>
                        <option value="Arraignment">Arraignment</option>
                        <option value="Return of Subpoena">Return of Subpoena</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="cdrCourt">Court:</label>
                    <input type="text" id="cdrCourt" placeholder="Enter court name">
                </div>
                
                <div class="form-group">
                    <label for="cdrCourtTime">Court Time:</label>
                    <input type="time" id="cdrCourtTime" value="09:30">
                </div>
                
                <div class="form-group">
                    <label>Allocate To:</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="allocate_AAG" value="AAG">
                            <label for="allocate_AAG">AAG</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="allocate_RHH" value="RHH">
                            <label for="allocate_RHH">RHH</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="allocate_SRS" value="SRS">
                            <label for="allocate_SRS">SRS</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="allocate_BJB" value="BJB">
                            <label for="allocate_BJB">BJB</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="allocate_NKM" value="NKM">
                            <label for="allocate_NKM">NKM</label>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="cdrClientExcused">
                        <label for="cdrClientExcused">Client Excused</label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="cdrFeeReminder">Fee Reminder:</label>
                    <input type="text" id="cdrFeeReminder" placeholder="Enter fee reminder details">
                </div>
            </div>
            
            <div style="margin-top: 30px;">
                <button class="btn btn-primary" onclick="generateCDR()">Generate CDR</button>
                <button class="btn btn-success" onclick="sendCDRToZapier()">Send CDR to Zapier</button>
                <button class="btn btn-secondary" onclick="clearCDRForm()">Clear Form</button>
            </div>
            
            <div id="cdrOutput" class="output-box" style="display: none;">
                <!-- Generated CDR appears here -->
            </div>
            
            <div id="cdrZapierStatus" style="display: none; margin-top: 10px; padding: 10px; border-radius: 4px;"></div>
        </div>
        
        <!-- Analytics Tab -->
        <div id="analytics" class="tab-content">
            <h2>Matter Analytics</h2>
            <p>Overview of your client matters and letter status</p>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                <div style="background: #f0f9ff; padding: 20px; border-radius: 8px; text-align: center;">
                    <h3 style="margin: 0; color: #0284c7;">Total Matters</h3>
                    <p style="font-size: 2em; font-weight: bold; margin: 10px 0; color: #0284c7;" id="totalMatters">0</p>
                </div>
                <div style="background: #f0fdf4; padding: 20px; border-radius: 8px; text-align: center;">
                    <h3 style="margin: 0; color: #16a34a;">Active Cases</h3>
                    <p style="font-size: 2em; font-weight: bold; margin: 10px 0; color: #16a34a;" id="activeMatters">0</p>
                </div>
                <div style="background: #fefce8; padding: 20px; border-radius: 8px; text-align: center;">
                    <h3 style="margin: 0; color: #ca8a04;">Pending Letters</h3>
                    <p style="font-size: 2em; font-weight: bold; margin: 10px 0; color: #ca8a04;" id="pendingLetters">0</p>
                </div>
                <div style="background: #fdf2f8; padding: 20px; border-radius: 8px; text-align: center;">
                    <h3 style="margin: 0; color: #be185d;">Next Week</h3>
                    <p style="font-size: 2em; font-weight: bold; margin: 10px 0; color: #be185d;" id="upcomingCourt">0</p>
                </div>
            </div>
            
            <div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3>Matters by Court</h3>
                <div id="courtBreakdown"></div>
            </div>
            
            <div style="background: white; padding: 20px; border-radius: 8px;">
                <h3>Letter Status Overview</h3>
                <div id="letterStatusChart"></div>
            </div>
        </div>
    </div>
    
    <!-- Add Client Modal -->
    <div id="addClientModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>Add New Client</h2>
            
            <form id="addClientForm" onsubmit="addClient(event)">
                <div class="form-group">
                    <label for="newClientName">Client Name:</label>
                    <input type="text" id="newClientName" required>
                </div>
                
                <div class="form-group">
                    <label for="newClientAddress">Address:</label>
                    <textarea id="newClientAddress" required></textarea>
                </div>
                
                <div class="form-group">
                    <label for="newMatterNumber">Matter Reference:</label>
                    <input type="text" id="newMatterNumber" required>
                </div>
                
                <div class="form-group">
                    <label for="newCourt">Court:</label>
                    <select id="newCourt" required>
                        <option value="">-- Select Court --</option>
                        <option value="Balmain Local Court">Balmain Local Court</option>
                        <option value="Bankstown Local Court">Bankstown Local Court</option>
                        <option value="Blacktown Local Court">Blacktown Local Court</option>
                        <option value="Burwood Local Court">Burwood Local Court</option>
                        <option value="Campbelltown District Court">Campbelltown District Court</option>
                        <option value="Campbelltown Local Court">Campbelltown Local Court</option>
                        <option value="Downing Centre District Court">Downing Centre District Court</option>
                        <option value="Downing Centre Local Court">Downing Centre Local Court</option>
                        <option value="Fairfield Local Court">Fairfield Local Court</option>
                        <option value="Hornsby Local Court">Hornsby Local Court</option>
                        <option value="Liverpool Local Court">Liverpool Local Court</option>
                        <option value="Manly Local Court">Manly Local Court</option>
                        <option value="Newtown Local Court">Newtown Local Court</option>
                        <option value="Parramatta District Court">Parramatta District Court</option>
                        <option value="Parramatta Local Court">Parramatta Local Court</option>
                        <option value="Penrith District Court">Penrith District Court</option>
                        <option value="Penrith Local Court">Penrith Local Court</option>
                        <option value="Sutherland Local Court">Sutherland Local Court</option>
                        <option value="Sydney District Court">Sydney District Court</option>
                        <option value="Waverley Local Court">Waverley Local Court</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="newMatterType">Matter Type:</label>
                    <select id="newMatterType" required>
                        <option value="">-- Select Matter Type --</option>
                        <option value="Criminal - Summary">Criminal - Summary</option>
                        <option value="Criminal - Indictable">Criminal - Indictable</option>
                        <option value="ADVO">ADVO</option>
                        <option value="Bail Application">Bail Application</option>
                        <option value="Appeal">Appeal</option>
                        <option value="Section 14 Application">Section 14 Application</option>
                        <option value="Trial">Trial</option>
                        <option value="Sentence">Sentence</option>
                        <option value="Committal">Committal</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="newCharges">Charges:</label>
                    <input type="text" id="newCharges" placeholder="e.g., Common Assault - s61 Crimes Act" required>
                </div>
                
                <div class="form-group">
                    <label for="newLegalAid">Legal Aid?</label>
                    <select id="newLegalAid">
                        <option value="No">No</option>
                        <option value="Yes">Yes</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="newNextCourt">Next Court Date:</label>
                    <input type="date" id="newNextCourt">
                </div>
                
                <button type="submit" class="btn btn-primary">Add Client</button>
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            </form>
        </div>
    </div>
    
    <button class="add-client-btn" onclick="openModal()" title="Add New Client">+</button>
    
    <script>
        // Rest of the functions that weren't defined in the head
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadSavedData();
            updateUI();
        });
        
        // Load saved data from localStorage
        function loadSavedData() {
            const savedClients = localStorage.getItem('legalClients');
            if (savedClients) {
                clients = JSON.parse(savedClients);
                updateDatabaseStatus(true);
            }
        }
        
        // Save data to localStorage
        function saveData() {
            localStorage.setItem('legalClients', JSON.stringify(clients));
        }
        
        // Update all UI elements
        function updateUI() {
            loadClientTable();
            loadClientSelect();
            loadCDRClientSelect();
            updateAnalytics();
        }
        
        // Update database status indicator
        function updateDatabaseStatus(connected) {
            const status = document.getElementById('databaseStatus');
            if (connected) {
                status.textContent = `Database: Connected (${clients.length} clients)`;
                status.className = 'database-status status-connected';
            } else {
                status.textContent = 'Database: Not Connected';
                status.className = 'database-status status-disconnected';
            }
        }
        
        // Load Excel file
        function loadExcelFile() {
            const fileInput = document.getElementById('excelFile');
            const file = fileInput.files[0];
            
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    // Convert Excel data to our format
                    clients = jsonData.map((row, index) => ({
                        id: index + 1,
                        name: row['Client Name'] || '',
                        address: row['Address'] || '',
                        matterNumber: row['Matter Reference'] || '',
                        court: row['Court'] || '',
                        matterType: row['Matter Type'] || '',
                        charges: row['Charges'] || '',
                        legalAid: row['Legal Aid'] === 'Yes',
                        contribution: row['Contribution'] || '',
                        status: row['Status'] || 'Active',
                        ccl: row['CCL Sent'] === 'Yes' || false,
                        mention: row['Mention Sent'] === 'Yes' || false,
                        final: row['Final Sent'] === 'Yes' || false,
                        nextCourt: row['Next Court Date'] || '',
                        letterHistory: []
                    }));
                    
                    saveData();
                    updateUI();
                    updateDatabaseStatus(true);
                    alert(`Successfully loaded ${clients.length} clients from Excel`);
                } catch (error) {
                    alert('Error loading Excel file: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        // Export to Excel
        function exportToExcel() {
            if (clients.length === 0) {
                alert('No data to export');
                return;
            }
            
            // Prepare data for export
            const exportData = clients.map(client => ({
                'Client Name': client.name,
                'Address': client.address,
                'Matter Reference': client.matterNumber,
                'Court': client.court,
                'Matter Type': client.matterType,
                'Charges': client.charges,
                'Legal Aid': client.legalAid ? 'Yes' : 'No',
                'Contribution': client.contribution || '',
                'Status': client.status,
                'CCL Sent': client.ccl ? 'Yes' : 'No',
                'Mention Sent': client.mention ? 'Yes' : 'No',
                'Final Sent': client.final ? 'Yes' : 'No',
                'Next Court Date': client.nextCourt,
                'Last Updated': new Date().toLocaleDateString('en-AU')
            }));
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(exportData);
            XLSX.utils.book_append_sheet(wb, ws, 'Clients');
            XLSX.writeFile(wb, `legal_clients_${new Date().toISOString().slice(0,10)}.xlsx`);
        }
        
        // Load client table
        function loadClientTable() {
            const tbody = document.getElementById('clientTableBody');
            
            if (clients.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" style="text-align: center; padding: 40px; color: #6b7280;">
                            No clients loaded. Please upload an Excel database or add clients manually.
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = clients.map(client => `
                <tr>
                    <td><strong>${client.name}</strong></td>
                    <td>${client.matterNumber}</td>
                    <td>${client.court}</td>
                    <td>${client.charges}</td>
                    <td><span class="status-badge status-${client.status.toLowerCase()}">${client.status}</span></td>
                    <td>${client.ccl ? '✅' : '❌'}</td>
                    <td>${client.mention ? '✅' : '❌'}</td>
                    <td>${client.final ? '✅' : '❌'}</td>
                    <td>${client.nextCourt ? formatDate(client.nextCourt) : 'TBD'}</td>
                    <td>
                        <button class="btn btn-primary" style="padding: 6px 12px; font-size: 12px;" onclick="selectClientForLetter(${client.id})">Generate Letter</button>
                    </td>
                </tr>
            `).join('');
        }
        
        // Load client select dropdown
        function loadClientSelect() {
            const select = document.getElementById('clientSelect');
            select.innerHTML = '<option value="">-- Select a Client --</option>';
            
            clients.forEach(client => {
                const option = document.createElement('option');
                option.value = client.id;
                option.textContent = `${client.name} (${client.matterNumber})`;
                select.appendChild(option);
            });
        }
        
        // Load CDR client select dropdown
        function loadCDRClientSelect() {
            const select = document.getElementById('cdrClientSelect');
            select.innerHTML = '<option value="">-- Manual Entry --</option>';
            
            clients.forEach(client => {
                const option = document.createElement('option');
                option.value = client.id;
                option.textContent = `${client.name} (${client.matterNumber})`;
                select.appendChild(option);
            });
        }
        
        // Load CDR client info
        function loadCDRClientInfo() {
            const clientId = parseInt(document.getElementById('cdrClientSelect').value);
            
            if (!clientId) {
                // Clear fields for manual entry
                document.getElementById('cdrClientName').value = '';
                document.getElementById('cdrFileNumber').value = '';
                document.getElementById('cdrCourt').value = '';
                document.getElementById('cdrOutcomeCourt').value = '';
                return;
            }
            
            const client = clients.find(c => c.id === clientId);
            if (!client) return;
            
            // Populate CDR fields
            document.getElementById('cdrClientName').value = client.name;
            document.getElementById('cdrFileNumber').value = client.matterNumber;
            document.getElementById('cdrCourt').value = client.court;
            document.getElementById('cdrOutcomeCourt').value = client.court;
            
            // If client has next court date, populate that too
            if (client.nextCourt) {
                document.getElementById('cdrCourtDate').value = client.nextCourt;
            }
        }
        
        // Toggle CDR fields in letter generation
        function toggleCDRFields() {
            const isChecked = document.getElementById('generateCDRWithLetter').checked;
            document.getElementById('cdrFieldsInLetter').style.display = isChecked ? 'block' : 'none';
        }
        
        // Select client from master list for letter generation
        function selectClientForLetter(clientId) {
            // Find the generator tab button and trigger click
            const generatorTab = document.querySelector('.tab:nth-child(2)');
            if (generatorTab) {
                generatorTab.click();
            }
            document.getElementById('clientSelect').value = clientId;
            loadClientInfo();
        }
        
        // Load client information
        function loadClientInfo() {
            const clientId = parseInt(document.getElementById('clientSelect').value);
            const clientInfoSection = document.getElementById('clientInfoSection');
            
            if (!clientId) {
                clientInfoSection.style.display = 'none';
                return;
            }
            
            currentClient = clients.find(c => c.id === clientId);
            if (!currentClient) return;
            
            clientInfoSection.style.display = 'block';
            
            // Populate client info grid
            document.getElementById('clientInfoGrid').innerHTML = `
                <div class="info-item">
                    <div class="info-label">Client Name</div>
                    <div class="info-value">${currentClient.name}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Address</div>
                    <div class="info-value">${currentClient.address || 'Not provided'}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Matter Number</div>
                    <div class="info-value">${currentClient.matterNumber}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Court</div>
                    <div class="info-value">${currentClient.court}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Matter Type</div>
                    <div class="info-value">${currentClient.matterType}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Charges</div>
                    <div class="info-value">${currentClient.charges}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Legal Aid</div>
                    <div class="info-value">${currentClient.legalAid ? 'Yes' : 'No'}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Next Court</div>
                    <div class="info-value">${currentClient.nextCourt ? formatDate(currentClient.nextCourt) : 'TBD'}</div>
                </div>
            `;
            
            // Populate letter history
            const historyList = document.getElementById('letterHistoryList');
            if (currentClient.letterHistory && currentClient.letterHistory.length > 0) {
                historyList.innerHTML = currentClient.letterHistory.map(letter => `
                    <div class="letter-item">
                        <div>
                            <strong>${letter.type}</strong> - ${formatDate(letter.date)}
                            <br><small>${letter.notes || ''}</small>
                        </div>
                        <span class="status-badge status-completed">Sent</span>
                    </div>
                `).join('');
            } else {
                historyList.innerHTML = '<p style="color: #6b7280; font-style: italic;">No letters sent yet</p>';
            }
        }
        
        // Update letter fields based on type
        function updateLetterFields() {
            const letterType = document.getElementById('letterType').value;
            const dynamicFields = document.getElementById('dynamicFields');
            const cdrSection = document.getElementById('cdrForLetterSection');
            
            if (!letterType || !currentClient) {
                dynamicFields.innerHTML = '';
                cdrSection.style.display = 'none';
                return;
            }
            
            // Show CDR section for all letter types
            cdrSection.style.display = 'block';
            
            let fieldsHTML = '';
            
            switch(letterType) {
                case 'CCL':
                    fieldsHTML = getCCLFields();
                    break;
                case 'Mention':
                    fieldsHTML = getMentionFields();
                    break;
                case 'Final':
                    fieldsHTML = getFinalFields();
                    break;
                case 'FeeReestimate':
                    fieldsHTML = getFeeReestimateFields();
                    break;
            }
            
            dynamicFields.innerHTML = fieldsHTML;
            
            // Initialize any conditional logic
            if (letterType === 'CCL') {
                toggleLegalAidFields();
                togglePleaOptions();
            }
        }
        
        // Get CCL specific fields
        function getCCLFields() {
            return `
                <div class="section">
                    <div class="section-title">Contact Details</div>
                    
                    <div class="form-group">
                        <label for="contactMethod">Contact Method*</label>
                        <select id="contactMethod" required>
                            <option value="">Select Contact Method</option>
                            <option value="Office attendance">Office attendance</option>
                            <option value="Phone call">Phone call</option>
                            <option value="Email">Email</option>
                            <option value="Police station">Police station</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="contactDate">Contact Date*</label>
                        <input type="date" id="contactDate" value="${getTodayDate()}" required>
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-title">Charges</div>
                    
                    <div class="charges-section">
                        <div class="charges-category">
                            <h4>Violence Offences</h4>
                            <div class="checkbox-group">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="charge_affray" value="Affray - s93C Crimes Act">
                                    <label for="charge_affray">Affray - s93C Crimes Act</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="charge_assault" value="Common Assault - s61 Crimes Act">
                                    <label for="charge_assault">Common Assault - s61 Crimes Act</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="charge_abh" value="Assault occasioning ABH - s59 Crimes Act">
                                    <label for="charge_abh">Assault occasioning ABH - s59</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="charge_assault_police" value="Assault Police - s60 Crimes Act">
                                    <label for="charge_assault_police">Assault Police - s60 Crimes Act</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="charge_resist" value="Resist Officer - s58 Crimes Act">
                                    <label for="charge_resist">Resist Officer - s58 Crimes Act</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="charges-category">
                            <h4>Domestic Violence</h4>
                            <div class="checkbox-group">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="charge_breach_avo" value="Breach AVO - s14 CDPV Act">
                                    <label for="charge_breach_avo">Breach AVO - s14 CDPV Act</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="charge_stalk" value="Stalk/Intimidate - s13 CDPV Act">
                                    <label for="charge_stalk">Stalk/Intimidate - s13 CDPV Act</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="charge_destroy" value="Destroy/Damage Property - s195 Crimes Act">
                                    <label for="charge_destroy">Destroy/Damage Property - s195</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="charges-category">
                            <h4>Traffic Offences</h4>
                            <div class="checkbox-group">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="charge_low_pca" value="Low Range PCA - s110(3) Road Transport Act">
                                    <label for="charge_low_pca">Low Range PCA - s110(3)</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="charge_mid_pca" value="Mid Range PCA - s110(4) Road Transport Act">
                                    <label for="charge_mid_pca">Mid Range PCA - s110(4)</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="charge_high_pca" value="High Range PCA - s110(5) Road Transport Act">
                                    <label for="charge_high_pca">High Range PCA - s110(5)</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="charge_disqualified" value="Drive whilst disqualified - s54(1) Road Transport Act">
                                    <label for="charge_disqualified">Drive whilst disqualified - s54(1)</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="charge_suspended" value="Drive whilst suspended - s54(1) Road Transport Act">
                                    <label for="charge_suspended">Drive whilst suspended - s54(1)</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="charges-category">
                            <h4>Drug Offences</h4>
                            <div class="checkbox-group">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="charge_possess" value="Possess Prohibited Drug - s10 DMTA">
                                    <label for="charge_possess">Possess Prohibited Drug - s10</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="charge_supply" value="Supply Prohibited Drug - s25 DMTA">
                                    <label for="charge_supply">Supply Prohibited Drug - s25</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="charges-category">
                            <h4>Property Offences</h4>
                            <div class="checkbox-group">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="charge_larceny" value="Larceny - s117 Crimes Act">
                                    <label for="charge_larceny">Larceny - s117 Crimes Act</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="charge_goods" value="Goods in Custody - s527C Crimes Act">
                                    <label for="charge_goods">Goods in Custody - s527C</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="additionalCharges">Additional Charges</label>
                        <input type="text" id="additionalCharges" placeholder="Enter any additional charges">
                    </div>
                    
                    <div class="form-group">
                        <label for="counts">Number of Counts</label>
                        <input type="number" id="counts" min="1" placeholder="e.g., 3">
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-title">Legal Aid & Fees</div>
                    
                    <div class="form-group">
                        <label for="legalAidStatus">Legal Aid?*</label>
                        <select id="legalAidStatus" onchange="toggleLegalAidFields()" required>
                            <option value="">Select</option>
                            <option value="Yes" ${currentClient.legalAid ? 'selected' : ''}>Yes</option>
                            <option value="No" ${!currentClient.legalAid ? 'selected' : ''}>No</option>
                        </select>
                    </div>
                    
                    <div class="conditional" id="legalAidDetails">
                        <div class="form-group">
                            <label for="contribution">Contribution Amount ($)</label>
                            <input type="number" id="contribution" placeholder="Leave blank if no contribution">
                        </div>
                    </div>
                    
                    <div class="conditional" id="privateDetails">
                        <div class="form-group">
                            <label for="estimate">Estimate Amount ($)*</label>
                            <input type="number" id="estimate" placeholder="e.g., 3500">
                        </div>
                        <div class="form-group">
                            <label for="depositPaid">Deposit Paid?</label>
                            <select id="depositPaid" onchange="toggleDepositAmount()">
                                <option value="No">No</option>
                                <option value="Yes">Yes</option>
                            </select>
                        </div>
                        <div class="conditional" id="depositDetails">
                            <div class="form-group">
                                <label for="depositAmount">Deposit Amount ($)</label>
                                <input type="number" id="depositAmount" placeholder="e.g., 1000">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-title">Instructions</div>
                    
                    <div class="form-group">
                        <label for="plea">Plea*</label>
                        <select id="plea" onchange="togglePleaOptions()" required>
                            <option value="">Select Plea</option>
                            <option value="Guilty">Guilty</option>
                            <option value="Not Guilty">Not Guilty</option>
                            ${currentClient.matterType === 'Criminal - Indictable' ? '<option value="No plea yet (indictable)">No plea yet (indictable)</option>' : ''}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="clientInstructions">Client Instructions*</label>
                        <textarea id="clientInstructions" placeholder="What are the client's instructions moving forward?" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="nextCourtDate">Next Court Date</label>
                        <input type="date" id="nextCourtDate" value="${currentClient.nextCourt || ''}">
                    </div>
                    
                    <div class="form-group">
                        <label for="requiredAttend">Client Required to Attend?</label>
                        <select id="requiredAttend">
                            <option value="">Select</option>
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                        </select>
                    </div>
                    
                    <div class="conditional" id="sentenceMaterials">
                        <label>Sentence Materials Discussed</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="mat_references" value="Character references">
                                <label for="mat_references">Character references</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="mat_psych_existing" value="Psych report - existing doctor">
                                <label for="mat_psych_existing">Psych report - existing doctor</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="mat_psych_referral" value="Psych report - need referral">
                                <label for="mat_psych_referral">Psych report - need referral</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="mat_traffic" value="Traffic Offenders Program">
                                <label for="mat_traffic">Traffic Offenders Program</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="mat_treatment" value="Drug/Alcohol treatment">
                                <label for="mat_treatment">Drug/Alcohol treatment</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="mat_other" value="Other treatment proof">
                                <label for="mat_other">Other treatment proof</label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-title">ADVO Details</div>
                    
                    <div class="form-group">
                        <label for="advoType">ADVO Type</label>
                        <select id="advoType" onchange="toggleADVOFields()">
                            <option value="">No ADVO</option>
                            <option value="Provisional">Provisional</option>
                            <option value="Interim">Interim</option>
                            <option value="Final">Final</option>
                        </select>
                    </div>
                    
                    <div class="conditional" id="advoDetails">
                        <div class="form-group">
                            <label for="pinop">PINOP Name*</label>
                            <input type="text" id="pinop" placeholder="Protected person's name">
                        </div>
                        
                        <div class="form-group">
                            <label for="advoDuration">Duration*</label>
                            <select id="advoDuration">
                                <option value="">Select Duration</option>
                                <option value="6 months">6 months</option>
                                <option value="12 months">12 months</option>
                                <option value="2 years">2 years</option>
                                <option value="5 years">5 years</option>
                                <option value="Indefinite">Indefinite</option>
                            </select>
                        </div>
                        
                        <label>ADVO Conditions (1 is mandatory)</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="advo_2" value="2">
                                <label for="advo_2">2 - No contact</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="advo_3" value="3">
                                <label for="advo_3">3 - No approach schools/childcare</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="advo_4" value="4">
                                <label for="advo_4">4 - No approach after alcohol/drugs</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="advo_5" value="5">
                                <label for="advo_5">5 - Must not locate</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="advo_6" value="6">
                                <label for="advo_6">6 - Contact through lawyer only</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="advo_7" value="7">
                                <label for="advo_7">7 - Cannot live at same address</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="advo_8" value="8">
                                <label for="advo_8">8 - Cannot go to residence/work</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="advo_9" value="9">
                                <label for="advo_9">9 - Stay away specified metres</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="advo_10" value="10">
                                <label for="advo_10">10 - No firearms/weapons</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="advo_11" value="11">
                                <label for="advo_11">11 - Other conditions</label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-title">Bail Conditions</div>
                    
                    <div class="form-group">
                        <label for="hasBail">Has Bail Conditions?</label>
                        <select id="hasBail" onchange="toggleBailFields()">
                            <option value="No">No</option>
                            <option value="Yes">Yes</option>
                        </select>
                    </div>
                    
                    <div class="conditional" id="bailDetails">
                        <label>Select Bail Conditions</label>
                        <select id="bailConditions" multiple class="multi-select">
                            <option value="Reside at specified address">Reside at specified address</option>
                            <option value="Report to police station daily">Report to police station daily</option>
                            <option value="Report to police station Monday, Wednesday, Friday">Report Mon/Wed/Fri</option>
                            <option value="Report to police station weekly">Report weekly</option>
                            <option value="Not to contact specified person">Not to contact specified person</option>
                            <option value="Not to contact prosecution witnesses">Not to contact witnesses</option>
                            <option value="Not to go within specified metres">Not to go within X metres</option>
                            <option value="Not to enter specified suburb">Not to enter suburb/location</option>
                            <option value="Not to leave New South Wales">Not to leave NSW</option>
                            <option value="Surrender passport">Surrender passport</option>
                            <option value="Curfew">Curfew</option>
                            <option value="Not to consume alcohol">Not to consume alcohol</option>
                            <option value="Not to consume illicit drugs">Not to consume drugs</option>
                            <option value="Not to enter licensed premises">Not to enter licensed premises</option>
                            <option value="Not to drive a motor vehicle">Not to drive</option>
                        </select>
                        <small>Hold Ctrl (or Cmd on Mac) to select multiple</small>
                        
                        <div class="form-group" style="margin-top: 10px;">
                            <label for="additionalBail">Additional Bail Conditions</label>
                            <textarea id="additionalBail" placeholder="Any additional bail conditions"></textarea>
                        </div>
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-title">Additional Information</div>
                    <div class="form-group">
                        <label for="additionalInfo">Additional Information</label>
                        <textarea id="additionalInfo" placeholder="Any other relevant information for this letter"></textarea>
                    </div>
                </div>
