<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Legal Letter Generation System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- CSS Modules -->
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/mobile.css">
    <link rel="stylesheet" href="css/alignment-fixes.css">
    
    <!-- JavaScript Modules -->
    <script src="js/utils.js"></script>
    <script src="js/client-database.js"></script>
    <script src="js/app.js"></script>
    <script src="js/letters.js"></script>
    <script src="js/cdr.js"></script>
    <script src="js/analytics.js"></script>
    <script src="js/file-note.js"></script>
    <script src="js/subpoena.js"></script>

    <script>
        // ===== MINIMAL INITIALIZATION =====
        // Most functionality is now in separate modules
        
        // ===== COURT CALENDAR FUNCTIONS =====
        // Court calendar functionality remains here for now
        const updateCourtCalendar = () => {
            if (!courtCalendarData || courtCalendarData.length === 0) {
                document.getElementById('calendarContent').innerHTML = '<p style="color: #6b7280; text-align: center;">No court calendar data available. Please load an Excel file with a CourtCalendar sheet.</p>';
                return;
            }

            const weekData = getWeekData(currentWeekNumber);
            const gridHTML = generateWeekGrid(weekData);
            document.getElementById('calendarContent').innerHTML = gridHTML;
        };

        const getWeekData = (weekNumber) => {
            return courtCalendarData.filter(item => item.weekNumber === weekNumber);
        };

        const generateWeekGrid = (weekData) => {
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
            const dayData = {};
            
            days.forEach(day => {
                dayData[day] = weekData.filter(item => item.dayName === day);
            });

            let gridHTML = '<div class="week-grid-container">';
            
            days.forEach(day => {
                const matters = dayData[day];
                const summary = getSummaryForDay(matters);
                const colorClass = getColorClass(summary.totalHours);
                
                gridHTML += `
                    <div class="day-card ${colorClass}" onclick="toggleDayDetails('${day}')">
                        <div class="day-header">${day}</div>
                        <div class="day-stats">
                            <div class="matter-count">${summary.count} ${summary.count === 1 ? 'matter' : 'matters'}</div>
                            <div class="hour-count">${summary.totalHours.toFixed(1)} hours</div>
                        </div>
                    </div>
                `;
            });
            
            gridHTML += '</div>';
            
            let detailsHTML = '<div class="daily-details-container">';
            days.forEach(day => {
                const matters = dayData[day];
                if (matters.length > 0) {
                    detailsHTML += `
                        <div class="day-details" id="details-${day}">
                            <h4>${day} Details</h4>
                            <div class="matters-list">
                                ${matters.map(matter => {
                                    const timeStr = matter.endTime ? matter.endTime : 'TBD';
                                    return `
                                        <div class="matter-item">
                                            <div class="matter-time">${timeStr}</div>
                                            <div class="matter-info">
                                                <div class="matter-client">${matter.clientName}</div>
                                                <div class="matter-details">${matter.matterType} - ${matter.court}</div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }
            });
            detailsHTML += '</div>';
            
            return gridHTML + detailsHTML + `
                <div class="week-summary">
                    <h3>Week ${currentWeekNumber} Summary</h3>
                    <div class="summary-stats">
                        <div class="stat-item">
                            <strong>Total Matters:</strong> ${weekData.length}
                        </div>
                        <div class="stat-item">
                            <strong>Total Hours:</strong> ${weekData.reduce((sum, item) => sum + item.durationHours, 0).toFixed(1)}
                        </div>
                    </div>
                </div>
            `;
        };

        const getSummaryForDay = (matters) => {
            return {
                count: matters.length,
                totalHours: matters.reduce((sum, matter) => sum + matter.durationHours, 0)
            };
        };

        const getColorClass = (hours) => {
            if (hours === 0) return 'day-empty';
            if (hours <= 2) return 'day-light';
            if (hours <= 4) return 'day-medium';
            return 'day-heavy';
        };

        const toggleDayDetails = (day) => {
            const details = document.getElementById(`details-${day}`);
            if (details) {
                details.style.display = details.style.display === 'none' ? 'block' : 'none';
            }
        };

        const navigateWeek = (direction) => {
            currentWeekNumber += direction;
            if (currentWeekNumber < 1) currentWeekNumber = 1;
            if (currentWeekNumber > 52) currentWeekNumber = 52;
            
            document.getElementById('currentWeek').textContent = currentWeekNumber;
            updateCourtCalendar();
        };

        const goToCurrentWeek = () => {
            const today = new Date();
            const startOfYear = new Date(today.getFullYear(), 0, 1);
            const days = Math.floor((today - startOfYear) / (24 * 60 * 60 * 1000));
            currentWeekNumber = Math.ceil((days + startOfYear.getDay() + 1) / 7);
            
            document.getElementById('currentWeek').textContent = currentWeekNumber;
            updateCourtCalendar();
        };

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize all modules
            loadSavedData();
            updateUI();
            initializeCheckboxHandlers();
            
            // Initialize current week
            if (currentWeekNumber === null) {
                goToCurrentWeek();
            }
            
            // Set up event handlers
            window.onclick = (event) => {
                const modal = document.getElementById('addClientModal');
                if (event.target === modal) closeModal();
            };
        });
    </script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Legal Letter Generation System</h1>
            <p>Streamlined client matter management and automated Claude prompt generation</p>
            <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>

        <div class="database-status" id="databaseStatus">Database: Not Connected</div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('master', event)">Master Client List</button>
            <button class="tab" onclick="switchTab('generator', event)">Letter Generator</button>
            <button class="tab" onclick="switchTab('cdr', event)">CDR</button>
            <button class="tab" onclick="switchTab('calendar', event)">Court Calendar</button>
            <button class="tab" onclick="switchTab('analytics', event)">Analytics</button>
            <button class="tab" onclick="switchTab('filenote', event)">File Note</button>
            <button class="tab" onclick="openSubpoenaSystem()">Subpoena</button>
        </div>

        <!-- Mobile Menu Overlay -->
        <div class="mobile-menu-overlay" onclick="closeMobileMenu()"></div>

        <!-- Mobile Menu -->
        <div class="mobile-menu">
            <div class="mobile-menu-header">
                <button class="mobile-menu-close" onclick="closeMobileMenu()">×</button>
            </div>
            <div class="mobile-menu-tabs">
                <button class="mobile-menu-tab active" onclick="switchTabMobile('master', event)">Master Client List</button>
                <button class="mobile-menu-tab" onclick="switchTabMobile('generator', event)">Letter Generator</button>
                <button class="mobile-menu-tab" onclick="switchTabMobile('cdr', event)">CDR</button>
                <button class="mobile-menu-tab" onclick="switchTabMobile('calendar', event)">Court Calendar</button>
                <button class="mobile-menu-tab" onclick="switchTabMobile('analytics', event)">Analytics</button>
                <button class="mobile-menu-tab" onclick="switchTabMobile('filenote', event)">File Note</button>
                <button class="mobile-menu-tab" onclick="openSubpoenaSystemMobile()">Subpoena</button>
            </div>
        </div>

        <!-- Master Client List (remains in main file) -->
        <div id="master" class="tab-content active">
            <div class="form-actions" style="margin-top: 20px;">
                <button onclick="openModal()" class="btn btn-primary">Add New Client</button>
                <input type="file" id="excelFile" accept=".xlsx,.xls" style="display: none;">
                <button onclick="document.getElementById('excelFile').click()" class="btn btn-secondary">Load Excel Database</button>
                <button onclick="loadExcelFile()" class="btn btn-success">Import Excel File</button>
            </div>

            <!-- Desktop table view -->
            <table class="master-table">
                <thead>
                    <tr>
                        <th>Client Name</th>
                        <th>Matter Number</th>
                        <th>Court</th>
                        <th>Charges</th>
                        <th>Status</th>
                        <th>CCL</th>
                        <th>Mention</th>
                        <th>Final</th>
                        <th>Next Court</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="clientTableBody">
                    <tr>
                        <td colspan="10" style="text-align: center; padding: 40px; color: #6b7280;">
                            No clients loaded. Please upload an Excel database or add clients manually.
                        </td>
                    </tr>
                </tbody>
            </table>

            <!-- Mobile cards view -->
            <div id="clientCardsContainer" style="display: none;"></div>
        </div>

        <!-- Module Container for Dynamic Loading -->
        <div id="moduleContainer" style="display: none;">
            <!-- Modules will be loaded here dynamically -->
        </div>

        <!-- Calendar Tab (remains in main file for now) -->
        <div id="calendar" class="tab-content">
            <h2>Court Calendar</h2>
            <p>View and manage court appearances by week</p>
            
            <div class="calendar-navigation">
                <button onclick="navigateWeek(-1)" class="btn btn-secondary">← Previous Week</button>
                <button onclick="goToCurrentWeek()" class="btn btn-primary">Current Week (<span id="currentWeek">1</span>)</button>
                <button onclick="navigateWeek(1)" class="btn btn-secondary">Next Week →</button>
            </div>
            
            <div id="calendarContent">
                <p style="color: #6b7280; text-align: center;">Loading calendar data...</p>
            </div>
        </div>

        <!-- Add Client Modal -->
        <div id="addClientModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal()">&times;</span>
                <h2>Add New Client</h2>
                <form id="addClientForm" onsubmit="addClient(event)">
                    <div class="form-group">
                        <label for="newClientName">Client Name:</label>
                        <input type="text" id="newClientName" required>
                    </div>
                    <div class="form-group">
                        <label for="newClientAddress">Address:</label>
                        <textarea id="newClientAddress"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="newMatterNumber">Matter Number:</label>
                        <input type="text" id="newMatterNumber" required>
                    </div>
                    <div class="form-group">
                        <label for="newCourt">Court:</label>
                        <input type="text" id="newCourt">
                    </div>
                    <div class="form-group">
                        <label for="newMatterType">Matter Type:</label>
                        <select id="newMatterType">
                            <option value="">Select type...</option>
                            <option value="Criminal">Criminal</option>
                            <option value="Traffic">Traffic</option>
                            <option value="AVO">AVO</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="newCharges">Charges:</label>
                        <textarea id="newCharges"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="newLegalAid">Legal Aid:</label>
                        <select id="newLegalAid">
                            <option value="No">No</option>
                            <option value="Yes">Yes</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="newNextCourt">Next Court Date:</label>
                        <input type="date" id="newNextCourt">
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Add Client</button>
                        <button type="button" onclick="closeModal()" class="btn btn-secondary">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Add Client Button -->
        <button class="add-client-btn" onclick="openModal()">+</button>
    </div>
</body>
</html>
